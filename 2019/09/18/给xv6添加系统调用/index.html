<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>ç»™xv6æ·»åŠ ç³»ç»Ÿè°ƒç”¨ | SS</title><link rel="stylesheet" type="text/css" href="../../../../css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/normalize/8.0.1/normalize.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//lib.baomitu.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//lib.baomitu.com/jquery/3.3.1/jquery.min.js"></script><link rel="icon" mask="" sizes="any" href="../../../../favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="../../../../favicon.ico"><link rel="apple-touch-icon" href="../../../../apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="../../../../apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="../../../../atom.xml"><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
ga('create','UA-134074056-1','auto');ga('send','pageview');</script><meta name="generator" content="Hexo 7.3.0"></head><body><div class="body_container"><div id="header"><div class="site-name"><a id="logo" href="../../../../.">SS</a><p class="description">ä¸çŸ¥é“åœ¨è¯´äº›ä»€ä¹ˆ</p></div><div id="nav-menu"><a class="current" href="../../../../."><i class="fa undefined"> é¦–é¡µ</i></a><a href="../../../../archives/"><i class="fa undefined"> å½’æ¡£</i></a><a href="../../../../about/"><i class="fa undefined"> å…³äº</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-4"><div class="content_container"><div class="post"><h1 class="post-title">ç»™xv6æ·»åŠ ç³»ç»Ÿè°ƒç”¨</h1><div class="post-meta">Sep 18, 2019<span> | </span><span class="category"><a href="../../../../categories/%F0%9F%90%B1%E6%9D%82%E8%B0%88/">ğŸ±æ‚è°ˆ</a></span><script src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> é˜…è¯»</span></span><span class="post-time"><span class="post-meta-item-text"> | </span><span class="post-meta-item-icon"><i class="fa fa-keyboard-o"></i><span class="post-count"> 1.9k</span><span class="post-meta-item-text"> å­—</span></span></span><span class="post-time"> | <span class="post-meta-item-icon"><i class="fa fa-hourglass-half"></i><span class="post-count"> 8</span><span class="post-meta-item-text"> åˆ†é’Ÿ</span></span></span></div><div class="post-content"><p>è¿™æ˜¯ã€ŠOperating System:Three Easy Piecesã€‹çš„projectä¹‹ä¸€ï¼š<a href="https://github.com/remzi-arpacidusseau/ostep-projects/tree/master/initial-xv6">initial-xv6</a>ï¼Œä½¿ç”¨çš„æ˜¯MITå¯¹unix v6ä¿®æ”¹è¿‡çš„x86ç‰ˆæœ¬<a href="https://github.com/mit-pdos/xv6-public">xv6</a>ã€‚</p>
<h2 id="ç³»ç»Ÿè°ƒç”¨"><a href="#ç³»ç»Ÿè°ƒç”¨" class="headerlink" title="ç³»ç»Ÿè°ƒç”¨"></a>ç³»ç»Ÿè°ƒç”¨</h2><p>æ±‡ç¼–æŒ‡ä»¤<strong>int n</strong>è°ƒç”¨interrupt procedureï¼ˆä¸­æ–­å¤„ç†è¿‡ç¨‹ï¼‰ï¼Œnçš„èŒƒå›´æ˜¯0ï½255ï¼Œnä½œä¸ºIDTï¼ˆinterrupt descriptor tableï¼‰çš„ç´¢å¼•å€¼ï¼Œå‰32ä¸ªä¸­æ–­æè¿°ç¬¦Intelè‡ªå·±ç”¨ï¼ˆä¸»è¦ç”¨äºå¼‚å¸¸ï¼‰ï¼Œæ‰§è¡Œintåç”±ç”¨æˆ·æ€å˜ä¸ºå†…æ ¸æ€ã€‚</p>
<h3 id="ç³»ç»Ÿè°ƒç”¨åˆå§‹åŒ–"><a href="#ç³»ç»Ÿè°ƒç”¨åˆå§‹åŒ–" class="headerlink" title="ç³»ç»Ÿè°ƒç”¨åˆå§‹åŒ–"></a>ç³»ç»Ÿè°ƒç”¨åˆå§‹åŒ–</h3><p>å¼‚å¸¸åˆ†ä¸ºä¸­æ–­ï¼ˆinterruptï¼‰ã€é™·é˜±ï¼ˆtrapï¼‰ã€æ•…éšœï¼ˆfaultï¼‰ã€ç»ˆæ­¢ï¼ˆabortï¼‰ã€‚ä¸­æ–­ä¸»è¦æ˜¯æ¥è‡ªI&#x2F;Oè®¾å¤‡çš„ä¿¡å·ç»“æœï¼Œä¸­æ–­æ˜¯å¼‚æ­¥çš„ï¼Œè€Œé™·é˜±ï¼ˆtrapï¼‰æ˜¯æœ‰æ„çš„å¼‚å¸¸ï¼Œä¸»è¦ç”¨äºå®ç°ç³»ç»Ÿè°ƒç”¨ï¼Œé™·é˜±æ˜¯åŒæ­¥çš„ã€‚ç»å…¸çš„æ•…éšœæ˜¯ç¼ºé¡µå¼‚å¸¸</p>
<p>ä¸ºäº†åœ¨å¼‚å¸¸å‘ç”Ÿæ—¶èƒ½å¤Ÿè°ƒç”¨å¯¹åº”çš„å¼‚å¸¸å¤„ç†è¿‡ç¨‹ï¼Œéœ€è¦åœ¨bootingçš„æ—¶å€™å¯¹IDTè¿›è¡Œåˆå§‹åŒ–ï¼Œè¿™ä¸ªæ“ä½œæ˜¯åœ¨main.c&#x2F;mainc()&#x2F;tvinit()ä¸­è¿›è¡Œçš„ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span></span><br><span class="line"><span class="title function_">tvinit</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> i;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; <span class="number">256</span>; i++)</span><br><span class="line">    SETGATE(idt[i], <span class="number">0</span>, SEG_KCODE&lt;&lt;<span class="number">3</span>, vectors[i], <span class="number">0</span>);</span><br><span class="line">  SETGATE(idt[T_SYSCALL], <span class="number">1</span>, SEG_KCODE&lt;&lt;<span class="number">3</span>, vectors[T_SYSCALL], DPL_USER);</span><br><span class="line"></span><br><span class="line">  initlock(&amp;tickslock, <span class="string">&quot;time&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>SETGATEå®ä¸»è¦ç”¨äºè®¾ç½®IDTä¸­æ¯ä¸ªä¸­æ–­æè¿°ç¬¦ï¼Œå½“å¯¹åº”nçš„ä¸­æ–­å‘ç”Ÿåå°±ä¼šè°ƒç”¨çš„ä»£ç </p>
<p>ä¸‹é¢æ˜¯<code>SETGATE</code>å®çš„ä»£ç ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> SETGATE(gate, istrap, sel, off, d)                \</span></span><br><span class="line"><span class="meta">&#123;                                                         \</span></span><br><span class="line"><span class="meta">  (gate).off_15_0 = (uint)(off) &amp; 0xffff;                \</span></span><br><span class="line"><span class="meta">  (gate).cs = (sel);                                      \</span></span><br><span class="line"><span class="meta">  (gate).args = 0;                                        \</span></span><br><span class="line"><span class="meta">  (gate).rsv1 = 0;                                        \</span></span><br><span class="line"><span class="meta">  (gate).type = (istrap) ? STS_TG32 : STS_IG32;           \</span></span><br><span class="line"><span class="meta">  (gate).s = 0;                                           \</span></span><br><span class="line"><span class="meta">  (gate).dpl = (d);                                       \</span></span><br><span class="line"><span class="meta">  (gate).p = 1;                                           \</span></span><br><span class="line"><span class="meta">  (gate).off_31_16 = (uint)(off) &gt;&gt; 16;                  \</span></span><br><span class="line"><span class="meta">&#125;</span></span><br></pre></td></tr></table></figure>

<p>ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ä¸­æ–­æè¿°ç¬¦ï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯è¿™ä¸ªæè¿°ç¬¦ç±»å‹ï¼Œå‚æ•°selè¡¨ç¤ºä»£ç æ®µé€‰æ‹©å™¨ï¼Œå‚æ•°offè¡¨ç¤ºåœ¨ä»£ç æ®µçš„åç§»ï¼Œå‚æ•°dè¡¨ç¤º<code>int n</code>æ¥è®¿é—®æè¿°ç¬¦æ‰€éœ€è¦çš„æƒé™ã€‚<code>SETGATE(idt[T_SYSCALL], 1, SEG_KCODE&lt;&lt;3, vectors[T_SYSCALL], DPL_USER);</code>è¡¨ç¤ºT_SYSCALLå¯¹åº”ç´¢å¼•ä¸­çš„æè¿°ç¬¦ç±»å‹ä¸ºtrapã€ä»£ç æ®µä½SEG_KCODEã€offsetä¸ºvectors[T_SYSCALL]ï¼Œå¯ä»¥åœ¨ç”¨æˆ·æ€çš„æ—¶å€™ç›´æ¥è°ƒç”¨ï¼Œå› æ­¤è¿™ä¸ªæè¿°ç¬¦ä¸»è¦å¤„ç†ç³»ç»Ÿè°ƒç”¨ã€‚</p>
<p>ä¸‹é¢æ˜¯æè¿°ç¬¦ç»“æ„ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">gatedesc</span> &#123;</span></span><br><span class="line">  uint off_15_0 : <span class="number">16</span>;   <span class="comment">// æ®µåœ°å€ä½16ä½</span></span><br><span class="line">  uint cs : <span class="number">16</span>;         <span class="comment">// ä»£ç æ®µé€‰æ‹©å™¨</span></span><br><span class="line">  uint args : <span class="number">5</span>;        <span class="comment">// # args, 0 for interrupt/trap gates</span></span><br><span class="line">  uint rsv1 : <span class="number">3</span>;        <span class="comment">// ä¿ç•™</span></span><br><span class="line">  uint type : <span class="number">4</span>;        <span class="comment">// ç±»å‹STS_IG32 32ä½ä¸­æ–­ï¼ŒSTS_TG32 32ä½é™·å…¥</span></span><br><span class="line">  uint s : <span class="number">1</span>;           <span class="comment">// must be 0 (system)</span></span><br><span class="line">  uint dpl : <span class="number">2</span>;         <span class="comment">// å¯ç”¨äºå†…æ ¸æƒé™è¿˜æ˜¯ç”¨æˆ·æ€æƒé™</span></span><br><span class="line">  uint p : <span class="number">1</span>;           <span class="comment">// ä¿ç•™å­—æ®µ</span></span><br><span class="line">  uint off_31_16 : <span class="number">16</span>;  <span class="comment">// æ®µä¸­åœ°å€çš„é«˜16ä½</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>csæ˜¯æ®µé€‰æ‹©å™¨ï¼Œå…±16ä½ï¼Œç¬¬0ï½1ä½è¡¨ç¤ºæƒé™ï¼ˆ0ï¼Œå†…æ ¸æƒé™ï¼›1ï¼Œç”¨æˆ·æ€ï¼‰ï¼Œç¬¬2ä½è¡¨ç¤ºæŒ‡å‘GDTï¼ˆ0ï¼Œå…¨å±€æ®µè¡¨ï¼‰è¿˜æ˜¯LDTï¼ˆ1ï¼Œå±€éƒ¨æ®µè¡¨ï¼‰ï¼Œç¬¬3ï½15ä½æ˜¯æ®µè¡¨ç´¢å¼•ã€‚</p>
<p>å½“ä¸­æ–­æè¿°ç¬¦è¡¨è®¾ç½®å¥½åï¼Œéœ€è¦è®©ç¡¬ä»¶èƒ½å¤Ÿæ„ŸçŸ¥ï¼Œæ‰€ä»¥æ±‡ç¼–æŒ‡ä»¤<code>lidt addr</code>ç”¨äºåŠ è½½ä¸­æ–­æè¿°ç¬¦åœ°å€åˆ°IDTRï¼ˆinterrupt descriptor table registorï¼‰è¿™ä¸ªåœ°å€æ˜¯6å­—èŠ‚ï¼ˆ32ä½ï¼‰å…¶ä¸­ä½16ä½è¡¨ç¤ºè¡¨å¤§å°ï¼Œé«˜32ä½æ˜¯ è¡¨åœ°å€ã€‚åœ¨main.c&#x2F;main&#x2F;mpmain&#x2F;idtinitä¸­è°ƒç”¨ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span></span><br><span class="line"><span class="title function_">idtinit</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">  lidt(idt, <span class="keyword">sizeof</span>(idt));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¸‹é¢æ˜¯lidtå‡½æ•°ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">void</span></span><br><span class="line"><span class="title function_">lidt</span><span class="params">(<span class="keyword">struct</span> gatedesc *p, <span class="type">int</span> size)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">volatile</span> ushort pd[<span class="number">3</span>];</span><br><span class="line">  pd[<span class="number">0</span>] = size<span class="number">-1</span>; <span class="comment">// gateå¤§å°</span></span><br><span class="line">  pd[<span class="number">1</span>] = (uint)p;</span><br><span class="line">  pd[<span class="number">2</span>] = (uint)p &gt;&gt; <span class="number">16</span>;</span><br><span class="line">  <span class="keyword">asm</span> <span class="title function_">volatile</span><span class="params">(<span class="string">&quot;lidt (%0)&quot;</span> : : <span class="string">&quot;r&quot;</span> (pd))</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="ç³»ç»Ÿè°ƒç”¨æ‰§è¡Œ"><a href="#ç³»ç»Ÿè°ƒç”¨æ‰§è¡Œ" class="headerlink" title="ç³»ç»Ÿè°ƒç”¨æ‰§è¡Œ"></a>ç³»ç»Ÿè°ƒç”¨æ‰§è¡Œ</h3><p>åœ¨ç”¨æˆ·æ€æ‰§è¡Œä¸‹é¢çš„ä»£ç è°ƒç”¨readç³»ç»Ÿè°ƒç”¨ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> sz = read(fd, buf, size);</span><br></pre></td></tr></table></figure>

<p>å®é™…ä¸Šreadç¬¦å·åœ¨usys.Sæ–‡ä»¶ä¸­å®šä¹‰ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#define SYSCALL(name) \</span><br><span class="line">  .globl name; \</span><br><span class="line">  name: \</span><br><span class="line">    movl $SYS_ ## name, %eax; \</span><br><span class="line">    int $T_SYSCALL; \</span><br><span class="line">    ret</span><br><span class="line"></span><br><span class="line">SYSCALL(read)</span><br></pre></td></tr></table></figure>

<p>SYSCALLæ˜¯å®å®šä¹‰ï¼Œ<code>SYSCALL(read)</code>å±•å¼€åç›¸å½“äºä¸‹é¢çš„ä»£ç ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">.global read;</span><br><span class="line">read:</span><br><span class="line">	movl $5, %eax;  // SYS_readåœ¨syscall.hä¸­å®šä¹‰ï¼Œç­‰äº5</span><br><span class="line">	int $64;</span><br><span class="line">	ret</span><br></pre></td></tr></table></figure>

<p>å½“intæŒ‡ä»¤è¢«è°ƒç”¨å‰ï¼Œç¡¬ä»¶å¿…é¡»ä¿å­˜å½“å‰çš„PC(eip)ã€eflagsã€espç­‰å¯„å­˜å™¨çš„å€¼ä¿å­˜åˆ°æ ˆä¸Šï¼Œè¿™äº›ä¿¡æ¯è¢«å®šä¹‰ä¸ºä¸ºtrapframeç»“æ„ä½“ï¼ˆx86.hï¼‰å› ä¸ºæ ˆæ˜¯ä»é«˜åˆ°ä½é¡ºåºï¼Œè€Œtrapframeæ˜¯ä»ä½åˆ°é«˜ï¼Œæ‰€ä»¥pushçš„é¡ºåºæ˜¯ä»trapframeæœ€åä¸€ä¸ªå­—æ®µå¼€å§‹çš„ã€‚ä¸‹é¢ä¸ºtrapframeç»“æ„ä½“ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">trapframe</span> &#123;</span></span><br><span class="line">  <span class="comment">// ä¸‹é¢çš„å¯„å­˜å™¨ç”±pushaä¿å­˜åˆ°æ ˆä¸Š</span></span><br><span class="line">  uint edi;</span><br><span class="line">  uint esi;</span><br><span class="line">  uint ebp;</span><br><span class="line">  uint oesp;      <span class="comment">// useless &amp; ignored</span></span><br><span class="line">  uint ebx;</span><br><span class="line">  uint edx;</span><br><span class="line">  uint ecx;</span><br><span class="line">  uint eax;</span><br><span class="line"> </span><br><span class="line">  <span class="comment">// æ‰‹åŠ¨pushä¿å­˜åˆ°æ ˆä¸Š</span></span><br><span class="line">  ushort gs;</span><br><span class="line">  ushort padding1;</span><br><span class="line">  ushort fs;</span><br><span class="line">  ushort padding2;</span><br><span class="line">  ushort es;</span><br><span class="line">  ushort padding3;</span><br><span class="line">  ushort ds;</span><br><span class="line">  ushort padding4;</span><br><span class="line">  uint trapno;  <span class="comment">// å¼‚å¸¸å·</span></span><br><span class="line"></span><br><span class="line"> <span class="comment">// ä¸‹é¢ç”±ç¡¬ä»¶ä¿å­˜åˆ°æ ˆä¸Š</span></span><br><span class="line">  uint err;</span><br><span class="line">  uint eip;</span><br><span class="line">  ushort cs;</span><br><span class="line">  ushort padding5;</span><br><span class="line">  uint eflags;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// below here only when crossing rings, such as from user to kernel</span></span><br><span class="line">  uint esp;</span><br><span class="line">  ushort ss;</span><br><span class="line">  ushort padding6;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>ç„¶å<code>int 64</code>å¼•å‘çš„trapï¼Œä¼šå»IDTä¸­å¾—åˆ°ä¸­æ–­æè¿°ç¬¦ï¼Œæ ¹æ®æè¿°ç¬¦æ‰§è¡Œ<code>vector64()</code>åœ¨vector.Sï¼ˆæœ‰vectors.plè„šæœ¬ç”Ÿæˆï¼‰ä¸­ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">.global vector64</span><br><span class="line">vector64:</span><br><span class="line">	pushl $64</span><br><span class="line">	jmp alltraps</span><br></pre></td></tr></table></figure>

<p>è¿™æ®µä»£ç å°†trapå·æ”¾å…¥æ ˆä¸­ï¼Œå¡«å……trapframeä¸­trapnoè¿™ä¸ªå­—æ®µã€‚ç„¶åè·³è½¬åˆ°<code>alltraps</code>ï¼ˆå…¶å®æ‰€æœ‰çš„å¼‚å¸¸éƒ½ä¼šè·³åˆ°alltrapsï¼Œé»˜è®¤çš„å¼‚å¸¸handleåªæ˜¯å°†trapnoè®¾ç½®ï¼‰ä¸­æ‰§è¡Œï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">.globl alltraps</span><br><span class="line">alltraps:</span><br><span class="line">  # å°†trapframeä¸­dsã€esã€fsã€gsä¿å­˜</span><br><span class="line">  pushl %ds</span><br><span class="line">  pushl %es</span><br><span class="line">  pushl %fs</span><br><span class="line">  pushl %gs</span><br><span class="line">  pushal  # æŒ‰ç…§EAX, ECX, EDX, EBX, ESP (original value), EBP, ESI,EDIé¡ºåºå­˜åˆ°æ ˆä¸Š</span><br><span class="line">  </span><br><span class="line">  # Set up data segments.</span><br><span class="line">  movw $(SEG_KDATA&lt;&lt;3), %ax  # åˆ‡æ¢ä¸ºå†…æ ¸ä»£ç æ®µï¼ŒSEG_KDATAä¸ºåœ°å€ï¼Œç¬¬0åˆ°3éƒ½ä¸º0è¡¨ç¤ºå†…æ ¸æƒé™ï¼Œä½¿ç”¨GDT</span><br><span class="line">  movw %ax, %ds</span><br><span class="line">  movw %ax, %es</span><br><span class="line"></span><br><span class="line">  # Call trap(tf), where tf=%esp</span><br><span class="line">  pushl %esp # æ­¤æ—¶espæŒ‡å‘trapframeï¼Œä½œä¸ºå‚æ•°ä¼ å…¥trapå‡½æ•°</span><br><span class="line">  call trap</span><br><span class="line">  addl $4, %esp</span><br></pre></td></tr></table></figure>

<p>æ¥ä¸‹æ¥æ‰€æœ‰çš„interrupt&#x2F;trap handleéƒ½ä¼šè¿›å…¥trapå‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°æ ¹æ®trapå·è¿›è¡Œé€‰æ‹©å¯¹åº”å¤„ç†å‡½æ•°ã€‚ä¸‹é¢ä¸ºtrapä»£ç ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span></span><br><span class="line"><span class="title function_">trap</span><span class="params">(<span class="keyword">struct</span> trapframe *tf)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span>(tf-&gt;trapno == T_SYSCALL)&#123; <span class="comment">// ç³»ç»Ÿè°ƒç”¨</span></span><br><span class="line">    <span class="keyword">if</span>(myproc()-&gt;killed)</span><br><span class="line">      <span class="built_in">exit</span>();</span><br><span class="line">    myproc()-&gt;tf = tf;</span><br><span class="line">    syscall();    <span class="comment">// æ‰§è¡Œè°ƒç”¨</span></span><br><span class="line">    <span class="keyword">if</span>(myproc()-&gt;killed)</span><br><span class="line">      <span class="built_in">exit</span>();</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">switch</span>(tf-&gt;trapno)&#123;</span><br><span class="line">  <span class="keyword">case</span> T_IRQ0 + IRQ_TIMER:</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  <span class="keyword">case</span> T_IRQ0 + IRQ_IDE:</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¹‹åè¿›å…¥<code>syscall()</code>å‡½æ•°ç»§ç»­æ‰§è¡Œï¼Œ</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span></span><br><span class="line"><span class="title function_">syscall</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> num;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">proc</span> *<span class="title">curproc</span> =</span> myproc();</span><br><span class="line"></span><br><span class="line">  num = curproc-&gt;tf-&gt;eax; <span class="comment">// ä¹‹å‰ä¿å­˜çš„ç³»ç»Ÿè°ƒç”¨å·</span></span><br><span class="line">  <span class="keyword">if</span>(num &gt; <span class="number">0</span> &amp;&amp; num &lt; NELEM(syscalls) &amp;&amp; syscalls[num]) &#123;</span><br><span class="line">    curproc-&gt;tf-&gt;eax = syscalls[num]();  <span class="comment">// æ‰§è¡Œå¯¹åº”çš„ç³»ç»Ÿè°ƒç”¨</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    cprintf(<span class="string">&quot;%d %s: unknown sys call %d\n&quot;</span>,</span><br><span class="line">            curproc-&gt;pid, curproc-&gt;name, num);</span><br><span class="line">    curproc-&gt;tf-&gt;eax = <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åœ¨syscallä¸­syscallså­˜æ”¾äº†ç³»ç»Ÿè°ƒç”¨å®ç°ç»„æˆçš„æ•°ç»„ï¼Œä¹‹åå°±è°ƒç”¨<code>sys_read()</code>ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="title function_">int</span> <span class="params">(*syscalls[])</span><span class="params">(<span class="type">void</span>)</span> = &#123;</span><br><span class="line">...</span><br><span class="line">[SYS_read]    sys_read,</span><br><span class="line">...</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>è¿”å›çš„å€¼è¢«ä¿å­˜åœ¨<code>curproc-&gt;tf&gt;eax</code>ä¸­ã€‚</p>
<h3 id="æ‰§è¡Œè¿”å›"><a href="#æ‰§è¡Œè¿”å›" class="headerlink" title="æ‰§è¡Œè¿”å›"></a>æ‰§è¡Œè¿”å›</h3><p>å½“<code>trap()</code>æ‰§è¡Œå®Œæ¯•åä¼šè¿”å›<code>alltrap</code>ï¼ˆtrapasm.Sï¼‰æ¥ç€å‘ä¸‹æ‰§è¡Œï¼Œ<code>alltrap</code>ä¸‹é¢çš„ä»£ç æ˜¯<code>trapret</code>ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">.globl trapret</span><br><span class="line">trapret:</span><br><span class="line">  popal</span><br><span class="line">  popl %gs</span><br><span class="line">  popl %fs</span><br><span class="line">  popl %es</span><br><span class="line">  popl %ds</span><br><span class="line">  addl $0x8, %esp  # trapno and errcode</span><br><span class="line">  iret</span><br></pre></td></tr></table></figure>

<p>ä»æ ˆä¸­æ¢å¤å„ä¸ªå¯„å­˜å™¨çš„å€¼ï¼Œè°ƒç”¨<code>iret</code>è¿”å›ç”¨æˆ·æ€è°ƒç”¨çš„readå‡½æ•°ç»§ç»­æ‰§è¡Œã€‚</p>
<h2 id="å®ç°ç³»ç»Ÿè°ƒç”¨"><a href="#å®ç°ç³»ç»Ÿè°ƒç”¨" class="headerlink" title="å®ç°ç³»ç»Ÿè°ƒç”¨"></a>å®ç°ç³»ç»Ÿè°ƒç”¨</h2><p>å®ç°<code>getreadcount(void)</code>è¿™ä¸ªç³»ç»Ÿè°ƒç”¨ï¼Œè¿”å›<code>read()</code>çš„ä½¿ç”¨æ¬¡æ•°ã€‚</p>
<p>é¦–å…ˆéœ€è¦åœ¨<code>usys.S</code>å¢åŠ è¿™ä¸ªç³»ç»Ÿè°ƒç”¨çš„åˆæ­¥å®ç°ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">SYSCALL(getreadcount)</span><br><span class="line">  </span><br><span class="line"><span class="comment">// ç›¸å½“äº</span></span><br><span class="line">.global getreadcount;</span><br><span class="line">getreadcount:</span><br><span class="line">	movl $SYS_getreadcount, %eax;</span><br><span class="line">	<span class="type">int</span> $T_SYSCALL;</span><br><span class="line">	ret</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°éœ€è¦æ·»åŠ <code>SYS_gettreadcount</code>ä½œä¸º<code>getreadcount()</code>çš„ç³»ç»Ÿè°ƒç”¨å·ï¼Œå› æ­¤åœ¨syscall.hä¸­æ·»åŠ </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> SYS_getreadcount  21</span></span><br></pre></td></tr></table></figure>

<p>æ­¤æ—¶è°ƒç”¨ä¼šè¿›å…¥IDTè¡¨ï¼Œæ‰¾åˆ°ç³»ç»Ÿè°ƒç”¨å¯¹åº”çš„ä¸­æ–­æè¿°ç¬¦ï¼Œæ‰§è¡Œ<code>syscall()</code>ï¼Œå› æ­¤éœ€è¦åœ¨<code>syscall.c</code>é‡Œé¢å¢åŠ <code>getreadcount</code>å¯¹åº”çš„å†…éƒ¨å®ç°ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">extern</span> <span class="type">int</span> <span class="title function_">sys_getreadcount</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="title function_">int</span> <span class="params">(*syscalls[])</span><span class="params">(<span class="type">void</span>)</span> = &#123;</span><br><span class="line">...</span><br><span class="line">[SYS_read]    sys_read,</span><br><span class="line">...</span><br><span class="line">[SYS_getreadcount]   sys_getreadcount,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><code>sys_getreadcount</code>ä¹Ÿå°±æ˜¯æˆ‘ä»¬éœ€è¦å®ç°çš„ï¼Œæˆ‘è¿™é‡Œæ˜¯å¢åŠ äº†ä¸€ä¸ªå…¨å±€å˜é‡<code>readcount</code>ï¼Œä»¥åŠç”¨äºé™åˆ¶å¹¶å‘çš„spinlockã€‚åœ¨<code>sysproc.c</code>å¢åŠ å®šä¹‰ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;spinlock.h&quot;</span></span></span><br><span class="line"></span><br><span class="line">uint readcount;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">spinlock</span> <span class="title">readcountlock</span>;</span></span><br></pre></td></tr></table></figure>

<p>åœ¨<code>sys_getreadcount</code>çš„é€»è¾‘å°±æ˜¯åŠ é”åè¯»å–<code>readcount</code>ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">sys_getreadcount</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">  <span class="type">int</span> count;</span><br><span class="line">  acquire(&amp;readcountlock);</span><br><span class="line">  count = readcount;</span><br><span class="line">  release(&amp;readcountlock);</span><br><span class="line">  <span class="keyword">return</span> count;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åœ¨<code>sys_read()</code>é‡Œé¢å¢åŠ è®¡æ•°ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">extern</span> uint readcount;</span><br><span class="line"><span class="keyword">extern</span> <span class="class"><span class="keyword">struct</span> <span class="title">spinlock</span> <span class="title">readcountlock</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span></span><br><span class="line"><span class="title function_">sys_read</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">file</span> *<span class="title">f</span>;</span></span><br><span class="line">  <span class="type">int</span> n;</span><br><span class="line">  <span class="type">char</span> *p;</span><br><span class="line">  </span><br><span class="line">	acquire(&amp;readcountlock);</span><br><span class="line">  readcount += <span class="number">1</span>;</span><br><span class="line">  release(&amp;readcountlock);</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">if</span>(argfd(<span class="number">0</span>, <span class="number">0</span>, &amp;f) &lt; <span class="number">0</span> || argint(<span class="number">2</span>, &amp;n) &lt; <span class="number">0</span> || argptr(<span class="number">1</span>, &amp;p, n) &lt; <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  <span class="keyword">return</span> fileread(f, p, n);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</div><div><ul class="post-copyright"><li class="post-copyright-author"><strong>æœ¬æ–‡ä½œè€…ï¼š</strong>ss</li><li class="post-copyright-link"><strong>æœ¬æ–‡é“¾æ¥ï¼š</strong><a href="/2019/09/18/ç»™xv6æ·»åŠ ç³»ç»Ÿè°ƒç”¨/">https://ssdemajia.github.io/2019/09/18/%E7%BB%99xv6%E6%B7%BB%E5%8A%A0%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8/</a></li><li class="post-copyright-license"><strong>ç‰ˆæƒå£°æ˜ï¼š</strong>æœ¬ç«™æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ <a href="http://creativecommons.org/licenses/by-nc-sa/3.0/cn/" rel="external nofollow" target="_blank">CC BY-NC-SA 3.0 CN</a> è®¸å¯åè®®ã€‚è½¬è½½è¯·æ³¨æ˜å‡ºå¤„ï¼</li></ul></div><br><div class="tags"><a href="../../../../tags/xv6/">xv6</a></div><div class="post-nav"><a class="pre" href="../../../../2020/02/13/afl%E7%99%BD%E7%9A%AE%E4%B9%A6/">ç¿»è¯‘ aflç™½çš®ä¹¦</a><a class="next" href="../../13/x64%E6%B1%87%E7%BC%96%E4%BB%8B%E7%BB%8D/">x64æ±‡ç¼–ä»‹ç»</a></div><div id="comments"><div id="disqus_thread"><div class="btn_click_load"><button class="disqus_click_btn">é˜…è¯»è¯„è®ºï¼ˆè¯·ç¡®ä¿ Disqus å¯ä»¥æ­£å¸¸åŠ è½½ï¼‰</button></div><script type="text/javascript">var disqus_config = function () {
    this.page.url = 'https://ssdemajia.github.io/2019/09/18/ç»™xv6æ·»åŠ ç³»ç»Ÿè°ƒç”¨/';
    this.page.identifier = '2019/09/18/ç»™xv6æ·»åŠ ç³»ç»Ÿè°ƒç”¨/';
    this.page.title = 'ç»™xv6æ·»åŠ ç³»ç»Ÿè°ƒç”¨';
  };</script><script type="text/javascript" id="disqus-lazy-load-script">$.ajax({
url: 'https://disqus.com/next/config.json',
timeout: 2500,
type: 'GET',
success: function(){
  var d = document;
  var s = d.createElement('script');
  s.src = '//dowob.disqus.com/embed.js';
  s.setAttribute('data-timestamp', + new Date());
  (d.head || d.body).appendChild(s);
  $('.disqus_click_btn').css('display', 'none');
},
error: function() {
  $('.disqus_click_btn').css('display', 'block');
}
});</script><script type="text/javascript" id="disqus-click-load">$('.btn_click_load').click(() => {  //click to load comments
    (() => { // DON'T EDIT BELOW THIS LINE
        var d = document;
        var s = d.createElement('script');
        s.src = '//dowob.disqus.com/embed.js';
        s.setAttribute('data-timestamp', + new Date());
        (d.head || d.body).appendChild(s);
    })();
    $('.disqus_click_btn').css('display','none');
});</script><script type="text/javascript" id="disqus-count-script">$(function() {
     var xhr = new XMLHttpRequest();
     xhr.open('GET', '//disqus.com/next/config.json', true);
     xhr.timeout = 2500;
     xhr.onreadystatechange = function () {
       if (xhr.readyState === 4 && xhr.status === 200) {
         $('.post-meta .post-comments-count').show();
         var s = document.createElement('script');
         s.id = 'dsq-count-scr';
         s.src = 'https://dowob.disqus.com/count.js';
         s.async = true;
         (document.head || document.body).appendChild(s);
       }
     };
     xhr.ontimeout = function () { xhr.abort(); };
     xhr.send(null);
   });  </script></div></div></div></div></div><div class="pure-u-1 pure-u-md-4"><div id="footer">Copyright Â© 2024 <a href="../../../../." rel="nofollow">SS.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/ssdemajia"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/ssdemajia"> SS.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="../../../../js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="../../../../js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="../../../../js/smartresize.js?v=0.0.0"></script></div></body></html>