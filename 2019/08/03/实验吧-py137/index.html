<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>实验吧 py137 | SS</title><link rel="stylesheet" type="text/css" href="../../../../css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/normalize/8.0.1/normalize.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//lib.baomitu.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//lib.baomitu.com/jquery/3.3.1/jquery.min.js"></script><link rel="icon" mask="" sizes="any" href="../../../../favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="../../../../favicon.ico"><link rel="apple-touch-icon" href="../../../../apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="../../../../apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="../../../../atom.xml"><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
ga('create','UA-134074056-1','auto');ga('send','pageview');</script><meta name="generator" content="Hexo 7.3.0"></head><body><div class="body_container"><div id="header"><div class="site-name"><a id="logo" href="../../../../.">SS</a><p class="description">不知道在说些什么</p></div><div id="nav-menu"><a class="current" href="../../../../."><i class="fa undefined"> 首页</i></a><a href="../../../../archives/"><i class="fa undefined"> 归档</i></a><a href="../../../../about/"><i class="fa undefined"> 关于</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-4"><div class="content_container"><div class="post"><h1 class="post-title">实验吧 py137</h1><div class="post-meta">Aug 3, 2019<span> | </span><span class="category"><a href="../../../../categories/%F0%9F%94%92%E5%AE%89%E5%85%A8/">🔒安全</a></span><script src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> 阅读</span></span><span class="post-time"><span class="post-meta-item-text"> | </span><span class="post-meta-item-icon"><i class="fa fa-keyboard-o"></i><span class="post-count"> 2.7k</span><span class="post-meta-item-text"> 字</span></span></span><span class="post-time"> | <span class="post-meta-item-icon"><i class="fa fa-hourglass-half"></i><span class="post-count"> 14</span><span class="post-meta-item-text"> 分钟</span></span></span></div><div class="post-content"><p>我一开始试了试uncompyle6，然而并没有什么用，感觉代码可能被改了很多。后面搜索到了方法，来自 <a href="https://0xd13a.github.io/ctfs/0ctf2017/py/">https://0xd13a.github.io/ctfs/0ctf2017/py/</a></p>
<p>首先阅读<a href="https://nedbatchelder.com/blog/200804/the_structure_of_pyc_files.html">https://nedbatchelder.com/blog/200804/the_structure_of_pyc_files.html</a> ，了解到pyc文件由三部分组成，分别是magic code（4字节）、时间戳（4字节）、marshal后的code（剩下）组成。作者提供了一个利用dis库、marshal库的程序。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># disassem.py</span></span><br><span class="line"><span class="keyword">import</span> dis, marshal, struct, sys, time, types</span><br><span class="line"><span class="keyword">import</span> roto</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show_file</span>(<span class="params">fname</span>):</span><br><span class="line">    f = <span class="built_in">open</span>(fname, <span class="string">&quot;rb&quot;</span>)</span><br><span class="line">    magic = f.read(<span class="number">4</span>)</span><br><span class="line">    moddate = f.read(<span class="number">4</span>)</span><br><span class="line">    modtime = time.asctime(time.localtime(struct.unpack(<span class="string">&#x27;I&#x27;</span>, moddate)[<span class="number">0</span>]))</span><br><span class="line">    <span class="built_in">print</span> <span class="string">&quot;magic %s&quot;</span> % (magic.encode(<span class="string">&#x27;hex&#x27;</span>))</span><br><span class="line">    <span class="built_in">print</span> <span class="string">&quot;moddate %s (%s)&quot;</span> % (moddate.encode(<span class="string">&#x27;hex&#x27;</span>), modtime)</span><br><span class="line">    code = marshal.load(f)</span><br><span class="line">    show_code(code)</span><br><span class="line">    </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show_code</span>(<span class="params">code, indent=<span class="string">&#x27;&#x27;</span></span>):</span><br><span class="line">    <span class="built_in">print</span> <span class="string">&quot;%scode&quot;</span> % indent</span><br><span class="line">    indent += <span class="string">&#x27;   &#x27;</span></span><br><span class="line">    <span class="built_in">print</span> <span class="string">&quot;%sargcount %d&quot;</span> % (indent, code.co_argcount)</span><br><span class="line">    <span class="built_in">print</span> <span class="string">&quot;%snlocals %d&quot;</span> % (indent, code.co_nlocals)</span><br><span class="line">    <span class="built_in">print</span> <span class="string">&quot;%sstacksize %d&quot;</span> % (indent, code.co_stacksize)</span><br><span class="line">    <span class="built_in">print</span> <span class="string">&quot;%sflags %04x&quot;</span> % (indent, code.co_flags)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;code length: %d&quot;</span> % (<span class="built_in">len</span>(code.co_code)))</span><br><span class="line">    show_hex(<span class="string">&quot;code&quot;</span>, code.co_code, indent=indent)</span><br><span class="line">    dis.disassemble(code)</span><br><span class="line">    <span class="built_in">print</span> <span class="string">&quot;%sconsts&quot;</span> % indent</span><br><span class="line">    <span class="keyword">for</span> const <span class="keyword">in</span> code.co_consts:</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">type</span>(const) == types.CodeType:</span><br><span class="line">            show_code(const, indent+<span class="string">&#x27;   &#x27;</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">print</span> <span class="string">&quot;   %s%r&quot;</span> % (indent, const)</span><br><span class="line">    <span class="built_in">print</span> <span class="string">&quot;%snames %r&quot;</span> % (indent, code.co_names)</span><br><span class="line">    <span class="built_in">print</span> <span class="string">&quot;%svarnames %r&quot;</span> % (indent, code.co_varnames)</span><br><span class="line">    <span class="built_in">print</span> <span class="string">&quot;%sfreevars %r&quot;</span> % (indent, code.co_freevars)</span><br><span class="line">    <span class="built_in">print</span> <span class="string">&quot;%scellvars %r&quot;</span> % (indent, code.co_cellvars)</span><br><span class="line">    <span class="built_in">print</span> <span class="string">&quot;%sfilename %r&quot;</span> % (indent, code.co_filename)</span><br><span class="line">    <span class="built_in">print</span> <span class="string">&quot;%sname %r&quot;</span> % (indent, code.co_name)</span><br><span class="line">    <span class="built_in">print</span> <span class="string">&quot;%sfirstlineno %d&quot;</span> % (indent, code.co_firstlineno)</span><br><span class="line">    show_hex(<span class="string">&quot;lnotab&quot;</span>, code.co_lnotab, indent=indent)</span><br><span class="line">    </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show_hex</span>(<span class="params">label, h, indent</span>):</span><br><span class="line">    h = h.encode(<span class="string">&#x27;hex&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(h) &lt; <span class="number">60</span>:</span><br><span class="line">        <span class="built_in">print</span> <span class="string">&quot;%s%s %s&quot;</span> % (indent, label, h)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span> <span class="string">&quot;%s%s&quot;</span> % (indent, label)</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(h), <span class="number">60</span>):</span><br><span class="line">            <span class="built_in">print</span> <span class="string">&quot;%s   %s&quot;</span> % (indent, h[i:i+<span class="number">60</span>])</span><br><span class="line"></span><br><span class="line">show_file(sys.argv[<span class="number">1</span>])</span><br></pre></td></tr></table></figure>

<p>然后我把这个代码改成python3，打开<code>python3 disassem.py crypt.pyc</code>，marshal库会报错ValueError，文档里面显示:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">because the data has a different Python version’s incompatible marshal format), raise [`EOFError`](exceptions.html#EOFError), [`ValueError`](exceptions.html#ValueError) or [`TypeError`](exceptions.html#TypeError). The file must be a readable [binary file](../glossary.html#term-binary-file).`</span><br></pre></td></tr></table></figure>

<p>也就是marshal这个库相对于pickle，不需要持久化很久，所以它会随着python版本发生改变。因为magic code由4个字节组成，前两个字节指示python版本号，可以通过查看python源码<a href="https://github.com/python/cpython/tree/2.7">https://github.com/python/cpython/tree/2.7</a> 中Python文件夹里的<code>import.c</code>文件：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">Known values:</span><br><span class="line">    Python 1.5:   20121</span><br><span class="line">    Python 1.5.1: 20121</span><br><span class="line">    Python 1.5.2: 20121</span><br><span class="line">    Python 1.6:   50428</span><br><span class="line">    Python 2.0:   50823</span><br><span class="line">    Python 2.0.1: 50823</span><br><span class="line">    Python 2.1:   60202</span><br><span class="line">    Python 2.1.1: 60202</span><br><span class="line">    Python 2.1.2: 60202</span><br><span class="line">    Python 2.2:   60717</span><br><span class="line">    Python 2.3a0: 62011</span><br><span class="line">    Python 2.3a0: 62021</span><br><span class="line">    Python 2.3a0: 62011 (!)</span><br><span class="line">    Python 2.4a0: 62041</span><br><span class="line">    Python 2.4a3: 62051</span><br><span class="line">    Python 2.4b1: 62061</span><br><span class="line">    Python 2.5a0: 62071</span><br><span class="line">    Python 2.5a0: 62081 (ast-branch)</span><br><span class="line">    Python 2.5a0: 62091 (with)</span><br><span class="line">    Python 2.5a0: 62092 (changed WITH_CLEANUP opcode)</span><br><span class="line">    Python 2.5b3: 62101 (fix wrong code: for x, in ...)</span><br><span class="line">    Python 2.5b3: 62111 (fix wrong code: x += yield)</span><br><span class="line">    Python 2.5c1: 62121 (fix wrong lnotab with for loops and</span><br><span class="line">                         storing constants that should have been removed)</span><br><span class="line">    Python 2.5c2: 62131 (fix wrong code: for x, in ... in listcomp/genexp)</span><br><span class="line">    Python 2.6a0: 62151 (peephole optimizations and STORE_MAP opcode)</span><br><span class="line">    Python 2.6a1: 62161 (WITH_CLEANUP optimization)</span><br><span class="line">    Python 2.7a0: 62171 (optimize list comprehensions/change LIST_APPEND)</span><br><span class="line">    Python 2.7a0: 62181 (optimize conditional branches:</span><br><span class="line">             introduce POP_JUMP_IF_FALSE and POP_JUMP_IF_TRUE)</span><br><span class="line">    Python 2.7a0  62191 (introduce SETUP_WITH)</span><br><span class="line">    Python 2.7a0  62201 (introduce BUILD_SET)</span><br><span class="line">    Python 2.7a0  62211 (introduce MAP_ADD and SET_ADD)</span><br></pre></td></tr></table></figure>

<p>这个pyc文件前两位是03 F3小端排列，相当于十进制的62211，所以这个pyc文件需要python2.7的解释器执行。</p>
<p>使用python2.7用同样的命令打开，在第23行<code>dis.disassemble(code)</code>会报错，因为这个pyc改了很多opcode，有些无法找到对应的opcode，因此注释这一行后继续执行，得到下面的结果。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line">magic 03f30d0a</span><br><span class="line">moddate 66346f58 (Fri Jan  6 01:08:38 2017)</span><br><span class="line">code</span><br><span class="line">   argcount 0</span><br><span class="line">   nlocals 0</span><br><span class="line">   stacksize 2</span><br><span class="line">   flags 0040</span><br><span class="line">code length: 34</span><br><span class="line">   code</span><br><span class="line">      990000990100860000910000990200880000910100990300880000910200</span><br><span class="line">      99010053</span><br><span class="line">   consts</span><br><span class="line">      -1</span><br><span class="line">      None</span><br><span class="line">      code</span><br><span class="line">         argcount 1</span><br><span class="line">         nlocals 6</span><br><span class="line">         stacksize 3</span><br><span class="line">         flags 0043</span><br><span class="line">code length: 92</span><br><span class="line">         code</span><br><span class="line">            990100680100990200680200990300680300610100990400469905002761</span><br><span class="line">            020061010027610300279906004627990500276102009906004627990700</span><br><span class="line">            276804009b00006001006104008301006805006105006002006100008301</span><br><span class="line">            0053</span><br><span class="line">         consts</span><br><span class="line">            None</span><br><span class="line">            &#x27;!@#$%^&amp;*&#x27;</span><br><span class="line">            &#x27;abcdefgh&#x27;</span><br><span class="line">            &#x27;&lt;&gt;&#123;&#125;:&quot;&#x27;</span><br><span class="line">            4</span><br><span class="line">            &#x27;|&#x27;</span><br><span class="line">            2</span><br><span class="line">            &#x27;EOF&#x27;</span><br><span class="line">         names (&#x27;rotor&#x27;, &#x27;newrotor&#x27;, &#x27;encrypt&#x27;)</span><br><span class="line">         varnames (&#x27;data&#x27;, &#x27;key_a&#x27;, &#x27;key_b&#x27;, &#x27;key_c&#x27;, &#x27;secret&#x27;, &#x27;rot&#x27;)</span><br><span class="line">         freevars ()</span><br><span class="line">         cellvars ()</span><br><span class="line">         filename &#x27;/Users/hen/Lab/0CTF/py/crypt.py&#x27;</span><br><span class="line">         name &#x27;encrypt&#x27;</span><br><span class="line">         firstlineno 2</span><br><span class="line">         lnotab 00010601060106012e010f01</span><br><span class="line">      code</span><br><span class="line">         argcount 1</span><br><span class="line">         nlocals 6</span><br><span class="line">         stacksize 3</span><br><span class="line">         flags 0043</span><br><span class="line">code length: 92</span><br><span class="line">         code</span><br><span class="line">            990100680100990200680200990300680300610100990400469905002761</span><br><span class="line">            020061010027610300279906004627990500276102009906004627990700</span><br><span class="line">            276804009b00006001006104008301006805006105006002006100008301</span><br><span class="line">            0053</span><br><span class="line">         consts</span><br><span class="line">            None</span><br><span class="line">            &#x27;!@#$%^&amp;*&#x27;</span><br><span class="line">            &#x27;abcdefgh&#x27;</span><br><span class="line">            &#x27;&lt;&gt;&#123;&#125;:&quot;&#x27;</span><br><span class="line">            4</span><br><span class="line">            &#x27;|&#x27;</span><br><span class="line">            2</span><br><span class="line">            &#x27;EOF&#x27;</span><br><span class="line">         names (&#x27;rotor&#x27;, &#x27;newrotor&#x27;, &#x27;decrypt&#x27;)</span><br><span class="line">         varnames (&#x27;data&#x27;, &#x27;key_a&#x27;, &#x27;key_b&#x27;, &#x27;key_c&#x27;, &#x27;secret&#x27;, &#x27;rot&#x27;)</span><br><span class="line">         freevars ()</span><br><span class="line">         cellvars ()</span><br><span class="line">         filename &#x27;/Users/hen/Lab/0CTF/py/crypt.py&#x27;</span><br><span class="line">         name &#x27;decrypt&#x27;</span><br><span class="line">         firstlineno 10</span><br><span class="line">         lnotab 00010601060106012e010f01</span><br><span class="line">   names (&#x27;rotor&#x27;, &#x27;encrypt&#x27;, &#x27;decrypt&#x27;)</span><br><span class="line">   varnames ()</span><br><span class="line">   freevars ()</span><br><span class="line">   cellvars ()</span><br><span class="line">   filename &#x27;/Users/hen/Lab/0CTF/py/crypt.py&#x27;</span><br><span class="line">   name &#x27;&lt;module&gt;&#x27;</span><br><span class="line">   firstlineno 1</span><br><span class="line">   lnotab 0c010908</span><br></pre></td></tr></table></figure>

<p>const是python代码中的静态变量，varnames是普通变量，names是外部变量。比如<code>a = str(1) + &#39;2&#39;</code>，其中a存在varnames，str存在names，1和’2’存在const中。</p>
<p>可以看到上面的pyc中使用了rotor这个外部变量，搜索后发现这是一个加密的库（<a href="http://www.bugingcode.com/blog/python_rotor.html">http://www.bugingcode.com/blog/python_rotor.html</a> ），大概用法如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> rotor</span><br><span class="line">key = <span class="string">&#x27;12345&#x27;</span></span><br><span class="line">rot = rotor.newrotor(key)</span><br><span class="line">rot.encrypt(balabala);</span><br><span class="line">rot.decrypt(balabala);</span><br></pre></td></tr></table></figure>

<p>看到pyc里有key_a、key_b、key_c、secret4个变量，大概会是有abc来生成secret。因为pyc文件里opcode会识别不了，所以我想要不改改dis.disassemble这个函数，让能识别先识别，不能的就留opcode的值。下面就是改了disassemble。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> op &gt;= HAVE_ARGUMENT:</span><br><span class="line">            oparg = <span class="built_in">ord</span>(code[i]) + <span class="built_in">ord</span>(code[i+<span class="number">1</span>])*<span class="number">256</span> + extended_arg</span><br><span class="line">            extended_arg = <span class="number">0</span></span><br><span class="line">            i = i+<span class="number">2</span></span><br><span class="line">            <span class="keyword">if</span> op == EXTENDED_ARG:</span><br><span class="line">                extended_arg = oparg*<span class="number">65536L</span></span><br><span class="line">            <span class="built_in">print</span> <span class="built_in">repr</span>(oparg).rjust(<span class="number">5</span>),</span><br><span class="line">            <span class="keyword">if</span> op <span class="keyword">in</span> hasconst:</span><br><span class="line">                <span class="keyword">if</span> oparg &gt;= <span class="built_in">len</span>(co.co_consts):</span><br><span class="line">                    <span class="built_in">print</span> <span class="string">&#x27;(const 0x&#x27;</span> + <span class="built_in">hex</span>(oparg) + <span class="string">&#x27;)&#x27;</span>,  <span class="comment"># 添加判断</span></span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    <span class="built_in">print</span> <span class="string">&#x27;(&#x27;</span> + <span class="built_in">repr</span>(co.co_consts[oparg]) + <span class="string">&#x27;)&#x27;</span>,</span><br><span class="line">            <span class="keyword">elif</span> op <span class="keyword">in</span> hasname:</span><br><span class="line">                <span class="keyword">if</span> oparg &gt;= <span class="built_in">len</span>(co.co_names):</span><br><span class="line">                    <span class="built_in">print</span> <span class="string">&#x27;(names 0x&#x27;</span> + <span class="built_in">hex</span>(oparg) + <span class="string">&#x27;)&#x27;</span>,  <span class="comment"># 添加判断</span></span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    <span class="built_in">print</span> <span class="string">&#x27;(&#x27;</span> + co.co_names[oparg] + <span class="string">&#x27;)&#x27;</span>,</span><br><span class="line">            <span class="keyword">elif</span> op <span class="keyword">in</span> hasjrel:</span><br><span class="line">                <span class="built_in">print</span> <span class="string">&#x27;(to &#x27;</span> + <span class="built_in">repr</span>(i + oparg) + <span class="string">&#x27;)&#x27;</span>,</span><br><span class="line">            <span class="keyword">elif</span> op <span class="keyword">in</span> haslocal:</span><br><span class="line">                <span class="built_in">print</span> <span class="string">&#x27;(&#x27;</span> + co.co_varnames[oparg] + <span class="string">&#x27;)&#x27;</span>,</span><br><span class="line">            <span class="keyword">elif</span> op <span class="keyword">in</span> hascompare:</span><br><span class="line">                <span class="built_in">print</span> <span class="string">&#x27;(&#x27;</span> + cmp_op[oparg] + <span class="string">&#x27;)&#x27;</span>,</span><br><span class="line">            <span class="keyword">elif</span> op <span class="keyword">in</span> hasfree:</span><br><span class="line">                <span class="keyword">if</span> free <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">                    free = co.co_cellvars + co.co_freevars</span><br><span class="line">                <span class="keyword">if</span> oparg &gt;= <span class="built_in">len</span>(free):</span><br><span class="line">                    <span class="built_in">print</span> <span class="string">&#x27;(free 0x&#x27;</span> + <span class="built_in">hex</span>(oparg) + <span class="string">&#x27;)&#x27;</span>,  <span class="comment"># 添加判断</span></span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    <span class="built_in">print</span> <span class="string">&#x27;(&#x27;</span> + free[oparg] + <span class="string">&#x27;)&#x27;</span>,</span><br><span class="line">        <span class="built_in">print</span></span><br></pre></td></tr></table></figure>

<p>然后再次运行<code>python3 disassem.py crypt.pyc</code>，但是得到的结果很迷：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br></pre></td><td class="code"><pre><span class="line">magic 03f30d0a</span><br><span class="line">moddate 66346f58 (Fri Jan  <span class="number">6</span> 01:08:<span class="number">38</span> <span class="number">2017</span>)</span><br><span class="line">code</span><br><span class="line">   argcount <span class="number">0</span></span><br><span class="line">   nlocals <span class="number">0</span></span><br><span class="line">   stacksize <span class="number">2</span></span><br><span class="line">   flags 0040</span><br><span class="line">code length: <span class="number">34</span></span><br><span class="line">   code</span><br><span class="line">      <span class="number">990000990100860000910000990200880000910100990300880000910200</span></span><br><span class="line">      <span class="number">99010053</span></span><br><span class="line">  <span class="number">1</span>           <span class="number">0</span> &lt;<span class="number">153</span>&gt;                    <span class="number">0</span></span><br><span class="line">              <span class="number">3</span> &lt;<span class="number">153</span>&gt;                    <span class="number">1</span></span><br><span class="line">              <span class="number">6</span> MAKE_CLOSURE             <span class="number">0</span></span><br><span class="line">              <span class="number">9</span> EXTENDED_ARG             <span class="number">0</span></span><br><span class="line"></span><br><span class="line">  <span class="number">2</span>          <span class="number">12</span> &lt;<span class="number">153</span>&gt;                   <span class="number">2L</span></span><br><span class="line">             <span class="number">15</span> LOAD_DEREF               <span class="number">0</span> (free 0x0x0)</span><br><span class="line">             <span class="number">18</span> EXTENDED_ARG             <span class="number">1</span></span><br><span class="line"></span><br><span class="line"> <span class="number">10</span>          <span class="number">21</span> &lt;<span class="number">153</span>&gt;                <span class="number">65539L</span></span><br><span class="line">             <span class="number">24</span> LOAD_DEREF               <span class="number">0</span> (free 0x0x0)</span><br><span class="line">             <span class="number">27</span> EXTENDED_ARG             <span class="number">2</span></span><br><span class="line">             <span class="number">30</span> &lt;<span class="number">153</span>&gt;                <span class="number">131073L</span></span><br><span class="line">             <span class="number">33</span> RETURN_VALUE        </span><br><span class="line">   consts</span><br><span class="line">      -<span class="number">1</span></span><br><span class="line">      <span class="literal">None</span></span><br><span class="line">      code</span><br><span class="line">         argcount <span class="number">1</span></span><br><span class="line">         nlocals <span class="number">6</span></span><br><span class="line">         stacksize <span class="number">3</span></span><br><span class="line">         flags 0043</span><br><span class="line">code length: <span class="number">92</span></span><br><span class="line">         code</span><br><span class="line">            <span class="number">990100680100990200680200990300680300610100990400469905002761</span></span><br><span class="line">            020061010027610300279906004627990500276102009906004627990700</span><br><span class="line">            276804009b00006001006104008301006805006105006002006100008301</span><br><span class="line">            0053</span><br><span class="line">  <span class="number">3</span>           <span class="number">0</span> &lt;<span class="number">153</span>&gt;                    <span class="number">1</span></span><br><span class="line">              <span class="number">3</span> BUILD_SET                <span class="number">1</span></span><br><span class="line"></span><br><span class="line">  <span class="number">4</span>           <span class="number">6</span> &lt;<span class="number">153</span>&gt;                    <span class="number">2</span></span><br><span class="line">              <span class="number">9</span> BUILD_SET                <span class="number">2</span></span><br><span class="line"></span><br><span class="line">  <span class="number">5</span>          <span class="number">12</span> &lt;<span class="number">153</span>&gt;                    <span class="number">3</span></span><br><span class="line">             <span class="number">15</span> BUILD_SET                <span class="number">3</span></span><br><span class="line"></span><br><span class="line">  <span class="number">6</span>          <span class="number">18</span> STORE_GLOBAL             <span class="number">1</span> (newrotor)</span><br><span class="line">             <span class="number">21</span> &lt;<span class="number">153</span>&gt;                    <span class="number">4</span></span><br><span class="line">             <span class="number">24</span> PRINT_EXPR          </span><br><span class="line">             <span class="number">25</span> &lt;<span class="number">153</span>&gt;                    <span class="number">5</span></span><br><span class="line">             <span class="number">28</span> &lt;<span class="number">39</span>&gt;                </span><br><span class="line">             <span class="number">29</span> STORE_GLOBAL             <span class="number">2</span> (encrypt)</span><br><span class="line">             <span class="number">32</span> STORE_GLOBAL             <span class="number">1</span> (newrotor)</span><br><span class="line">             <span class="number">35</span> &lt;<span class="number">39</span>&gt;                </span><br><span class="line">             <span class="number">36</span> STORE_GLOBAL             <span class="number">3</span> (names 0x0x3)</span><br><span class="line">             <span class="number">39</span> &lt;<span class="number">39</span>&gt;                </span><br><span class="line">             <span class="number">40</span> &lt;<span class="number">153</span>&gt;                    <span class="number">6</span></span><br><span class="line">             <span class="number">43</span> PRINT_EXPR          </span><br><span class="line">             <span class="number">44</span> &lt;<span class="number">39</span>&gt;                </span><br><span class="line">             <span class="number">45</span> &lt;<span class="number">153</span>&gt;                    <span class="number">5</span></span><br><span class="line">             <span class="number">48</span> &lt;<span class="number">39</span>&gt;                </span><br><span class="line">             <span class="number">49</span> STORE_GLOBAL             <span class="number">2</span> (encrypt)</span><br><span class="line">             <span class="number">52</span> &lt;<span class="number">153</span>&gt;                    <span class="number">6</span></span><br><span class="line">             <span class="number">55</span> PRINT_EXPR          </span><br><span class="line">             <span class="number">56</span> &lt;<span class="number">39</span>&gt;                </span><br><span class="line">             <span class="number">57</span> &lt;<span class="number">153</span>&gt;                    <span class="number">7</span></span><br><span class="line">             <span class="number">60</span> &lt;<span class="number">39</span>&gt;                </span><br><span class="line">             <span class="number">61</span> BUILD_SET                <span class="number">4</span></span><br><span class="line"></span><br><span class="line">  <span class="number">7</span>          <span class="number">64</span> &lt;<span class="number">155</span>&gt;                    <span class="number">0</span></span><br><span class="line">             <span class="number">67</span> DELETE_ATTR              <span class="number">1</span> (newrotor)</span><br><span class="line">             <span class="number">70</span> STORE_GLOBAL             <span class="number">4</span> (names 0x0x4)</span><br><span class="line">             <span class="number">73</span> CALL_FUNCTION            <span class="number">1</span></span><br><span class="line">             <span class="number">76</span> BUILD_SET                <span class="number">5</span></span><br><span class="line"></span><br><span class="line">  <span class="number">8</span>          <span class="number">79</span> STORE_GLOBAL             <span class="number">5</span> (names 0x0x5)</span><br><span class="line">             <span class="number">82</span> DELETE_ATTR              <span class="number">2</span> (encrypt)</span><br><span class="line">             <span class="number">85</span> STORE_GLOBAL             <span class="number">0</span> (rotor)</span><br><span class="line">             <span class="number">88</span> CALL_FUNCTION            <span class="number">1</span></span><br><span class="line">             <span class="number">91</span> RETURN_VALUE        </span><br><span class="line">         consts</span><br><span class="line">            <span class="literal">None</span></span><br><span class="line">            <span class="string">&#x27;!@#$%^&amp;*&#x27;</span></span><br><span class="line">            <span class="string">&#x27;abcdefgh&#x27;</span></span><br><span class="line">            <span class="string">&#x27;&lt;&gt;&#123;&#125;:&quot;&#x27;</span></span><br><span class="line">            <span class="number">4</span></span><br><span class="line">            <span class="string">&#x27;|&#x27;</span></span><br><span class="line">            <span class="number">2</span></span><br><span class="line">            <span class="string">&#x27;EOF&#x27;</span></span><br><span class="line">         names (<span class="string">&#x27;rotor&#x27;</span>, <span class="string">&#x27;newrotor&#x27;</span>, <span class="string">&#x27;encrypt&#x27;</span>)</span><br><span class="line">         varnames (<span class="string">&#x27;data&#x27;</span>, <span class="string">&#x27;key_a&#x27;</span>, <span class="string">&#x27;key_b&#x27;</span>, <span class="string">&#x27;key_c&#x27;</span>, <span class="string">&#x27;secret&#x27;</span>, <span class="string">&#x27;rot&#x27;</span>)</span><br><span class="line">         freevars ()</span><br><span class="line">         cellvars ()</span><br><span class="line">         filename <span class="string">&#x27;/Users/hen/Lab/0CTF/py/crypt.py&#x27;</span></span><br><span class="line">         name <span class="string">&#x27;encrypt&#x27;</span></span><br><span class="line">         firstlineno <span class="number">2</span></span><br><span class="line">         lnotab <span class="number">00010601060106012e0</span>10f01</span><br><span class="line">      code</span><br><span class="line">         argcount <span class="number">1</span></span><br><span class="line">         nlocals <span class="number">6</span></span><br><span class="line">         stacksize <span class="number">3</span></span><br><span class="line">         flags 0043</span><br><span class="line">code length: <span class="number">92</span></span><br><span class="line">         code</span><br><span class="line">            <span class="number">990100680100990200680200990300680300610100990400469905002761</span></span><br><span class="line">            020061010027610300279906004627990500276102009906004627990700</span><br><span class="line">            276804009b00006001006104008301006805006105006002006100008301</span><br><span class="line">            0053</span><br><span class="line"> <span class="number">11</span>           <span class="number">0</span> &lt;<span class="number">153</span>&gt;                    <span class="number">1</span></span><br><span class="line">              <span class="number">3</span> BUILD_SET                <span class="number">1</span></span><br><span class="line"></span><br><span class="line"> <span class="number">12</span>           <span class="number">6</span> &lt;<span class="number">153</span>&gt;                    <span class="number">2</span></span><br><span class="line">              <span class="number">9</span> BUILD_SET                <span class="number">2</span></span><br><span class="line"></span><br><span class="line"> <span class="number">13</span>          <span class="number">12</span> &lt;<span class="number">153</span>&gt;                    <span class="number">3</span></span><br><span class="line">             <span class="number">15</span> BUILD_SET                <span class="number">3</span></span><br><span class="line"></span><br><span class="line"> <span class="number">14</span>          <span class="number">18</span> STORE_GLOBAL             <span class="number">1</span> (newrotor)</span><br><span class="line">             <span class="number">21</span> &lt;<span class="number">153</span>&gt;                    <span class="number">4</span></span><br><span class="line">             <span class="number">24</span> PRINT_EXPR          </span><br><span class="line">             <span class="number">25</span> &lt;<span class="number">153</span>&gt;                    <span class="number">5</span></span><br><span class="line">             <span class="number">28</span> &lt;<span class="number">39</span>&gt;                </span><br><span class="line">             <span class="number">29</span> STORE_GLOBAL             <span class="number">2</span> (decrypt)</span><br><span class="line">             <span class="number">32</span> STORE_GLOBAL             <span class="number">1</span> (newrotor)</span><br><span class="line">             <span class="number">35</span> &lt;<span class="number">39</span>&gt;                </span><br><span class="line">             <span class="number">36</span> STORE_GLOBAL             <span class="number">3</span> (names 0x0x3)</span><br><span class="line">             <span class="number">39</span> &lt;<span class="number">39</span>&gt;                </span><br><span class="line">             <span class="number">40</span> &lt;<span class="number">153</span>&gt;                    <span class="number">6</span></span><br><span class="line">             <span class="number">43</span> PRINT_EXPR          </span><br><span class="line">             <span class="number">44</span> &lt;<span class="number">39</span>&gt;                </span><br><span class="line">             <span class="number">45</span> &lt;<span class="number">153</span>&gt;                    <span class="number">5</span></span><br><span class="line">             <span class="number">48</span> &lt;<span class="number">39</span>&gt;                </span><br><span class="line">             <span class="number">49</span> STORE_GLOBAL             <span class="number">2</span> (decrypt)</span><br><span class="line">             <span class="number">52</span> &lt;<span class="number">153</span>&gt;                    <span class="number">6</span></span><br><span class="line">             <span class="number">55</span> PRINT_EXPR          </span><br><span class="line">             <span class="number">56</span> &lt;<span class="number">39</span>&gt;                </span><br><span class="line">             <span class="number">57</span> &lt;<span class="number">153</span>&gt;                    <span class="number">7</span></span><br><span class="line">             <span class="number">60</span> &lt;<span class="number">39</span>&gt;                </span><br><span class="line">             <span class="number">61</span> BUILD_SET                <span class="number">4</span></span><br><span class="line"></span><br><span class="line"> <span class="number">15</span>          <span class="number">64</span> &lt;<span class="number">155</span>&gt;                    <span class="number">0</span></span><br><span class="line">             <span class="number">67</span> DELETE_ATTR              <span class="number">1</span> (newrotor)</span><br><span class="line">             <span class="number">70</span> STORE_GLOBAL             <span class="number">4</span> (names 0x0x4)</span><br><span class="line">             <span class="number">73</span> CALL_FUNCTION            <span class="number">1</span></span><br><span class="line">             <span class="number">76</span> BUILD_SET                <span class="number">5</span></span><br><span class="line"></span><br><span class="line"> <span class="number">16</span>          <span class="number">79</span> STORE_GLOBAL             <span class="number">5</span> (names 0x0x5)</span><br><span class="line">             <span class="number">82</span> DELETE_ATTR              <span class="number">2</span> (decrypt)</span><br><span class="line">             <span class="number">85</span> STORE_GLOBAL             <span class="number">0</span> (rotor)</span><br><span class="line">             <span class="number">88</span> CALL_FUNCTION            <span class="number">1</span></span><br><span class="line">             <span class="number">91</span> RETURN_VALUE        </span><br><span class="line">         consts</span><br><span class="line">            <span class="literal">None</span></span><br><span class="line">            <span class="string">&#x27;!@#$%^&amp;*&#x27;</span></span><br><span class="line">            <span class="string">&#x27;abcdefgh&#x27;</span></span><br><span class="line">            <span class="string">&#x27;&lt;&gt;&#123;&#125;:&quot;&#x27;</span></span><br><span class="line">            <span class="number">4</span></span><br><span class="line">            <span class="string">&#x27;|&#x27;</span></span><br><span class="line">            <span class="number">2</span></span><br><span class="line">            <span class="string">&#x27;EOF&#x27;</span></span><br><span class="line">         names (<span class="string">&#x27;rotor&#x27;</span>, <span class="string">&#x27;newrotor&#x27;</span>, <span class="string">&#x27;decrypt&#x27;</span>)</span><br><span class="line">         varnames (<span class="string">&#x27;data&#x27;</span>, <span class="string">&#x27;key_a&#x27;</span>, <span class="string">&#x27;key_b&#x27;</span>, <span class="string">&#x27;key_c&#x27;</span>, <span class="string">&#x27;secret&#x27;</span>, <span class="string">&#x27;rot&#x27;</span>)</span><br><span class="line">         freevars ()</span><br><span class="line">         cellvars ()</span><br><span class="line">         filename <span class="string">&#x27;/Users/hen/Lab/0CTF/py/crypt.py&#x27;</span></span><br><span class="line">         name <span class="string">&#x27;decrypt&#x27;</span></span><br><span class="line">         firstlineno <span class="number">10</span></span><br><span class="line">         lnotab <span class="number">00010601060106012e0</span>10f01</span><br><span class="line">   names (<span class="string">&#x27;rotor&#x27;</span>, <span class="string">&#x27;encrypt&#x27;</span>, <span class="string">&#x27;decrypt&#x27;</span>)</span><br><span class="line">   varnames ()</span><br><span class="line">   freevars ()</span><br><span class="line">   cellvars ()</span><br><span class="line">   filename <span class="string">&#x27;/Users/hen/Lab/0CTF/py/crypt.py&#x27;</span></span><br><span class="line">   name <span class="string">&#x27;&lt;module&gt;&#x27;</span></span><br><span class="line">   firstlineno <span class="number">1</span></span><br><span class="line">   lnotab 0c010908</span><br></pre></td></tr></table></figure>

<p>结果很迷，特别是150行、151行，应该是load attr、load name然后call function才对。然后我想着要不解析手工试试，python指令格式如: opcode + 参数位置 + 0x00组合，比如load_const 1 表示加载第1个（从0开始）的const变量，load_const的opcode是0x64，所以load_const 1表示0x64 0x01 0x00。opcode对应数字可以在<a href="https://github.com/python/cpython/blob/2.7/Include/opcode.h">https://github.com/python/cpython/blob/2.7/Include/opcode.h</a> 查看，其他的比如return 只有一个字节0x53表示，然后我按照这个规律分析code。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">990100  LOAD CONST  &#x27;!@#$%^&amp;*&#x27;</span><br><span class="line">680100  store varname keya</span><br><span class="line">990200  LOAD CONST  &#x27;abcdefgh&#x27;</span><br><span class="line">680200  store varname keyb</span><br><span class="line">990300  LOAD CONST  &#x27;&lt;&gt;&#123;&#125;:&quot;&#x27;</span><br><span class="line">680300  store varname keyc</span><br><span class="line">610100  load varname keya</span><br><span class="line">990400  LOAD CONST 4</span><br><span class="line">46      某个操作需要参数key_a与4</span><br><span class="line">990500  LOAD CONST &#x27;|&#x27;</span><br><span class="line">27</span><br><span class="line">610200  load varname keyb</span><br><span class="line">610100  load varname keya</span><br><span class="line">27      </span><br><span class="line">610300  load varname keyc</span><br><span class="line">27</span><br><span class="line">990600  LOAD CONST 2</span><br><span class="line">46      某个与2</span><br><span class="line">27</span><br><span class="line">990500  LOAD CONST &#x27;|&#x27; </span><br><span class="line">27</span><br><span class="line">610200  load varname keyb</span><br><span class="line">990600  LOAD CONST 2</span><br><span class="line">46      keyb与2的操作</span><br><span class="line">27      难道是+号？</span><br><span class="line">990700  LOAD CONST &#x27;EOF&#x27;</span><br><span class="line">27</span><br><span class="line">680400  store varname secret</span><br><span class="line">9b0000</span><br><span class="line">600100  load attr newrotor</span><br><span class="line">610400  load varname secret</span><br><span class="line">830100  call function newrotor</span><br><span class="line">680500  store varname rot</span><br><span class="line">610500  load varname rot</span><br><span class="line">600200  load attr encrypt</span><br><span class="line">610000  load varname data</span><br><span class="line">830100  call function encrypt</span><br><span class="line">53      return</span><br></pre></td></tr></table></figure>

<p>但是如果按照opcode来翻译上面的代码会出现问题，比如610000应该store_global、990700等等不对应的情况，所以我看了看大佬怎么写的，发现他是自己写一个rotor的脚本，再反编译后与crypt.pyc作对比，我按照他的思路将字节码翻译，特别的99应该是const因为第26行99070取出第8个变量，而只有const静态变量里面有8个元素，故99表示load const。但是里面的0x46、0x27并不知道是怎么操作，比如第9行前，load varname keya，load const 4, 相当于op1(keya, 4)，python里面使用栈来传参数，参数顺序按照栈底到栈顶的顺序。因此观察0x46和0x27的部分代码，将其变为伪代码，其中op1表示0x46、op2表示0x27:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">secret = op2(op1(op1(op2(op1(keya, 4), &#x27;|&#x27;), op1(op2(op2(keyb, keya), keyc), 2)), &#x27;|&#x27;), op2(keyb, 2))</span><br></pre></td></tr></table></figure>

<p>其中keya是字符串，而4是整数，那么<code>op1(keya, 4)</code>的操作应该是<code>*</code>，返回字符串，而<code>op2(op1(keya, 4), &#39;|&#39;)</code>是两个字符串的操作，应该是<code>+</code>，故secret可以通过下面的代码得到:</p>
<p><code>secret = key_a * 4 + &#39;|&#39; + (key_b + key_a + key_c)*2 + &#39;|&#39; + key_b*2 + &#39;EOF&#39;</code></p>
<p>然后将这串代码写成脚本来实现对encrypt_flag的解密</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> rotor</span><br><span class="line">key_a = <span class="string">&#x27;!@#$%^&amp;*&#x27;</span></span><br><span class="line">key_b = <span class="string">&#x27;abcdefgh&#x27;</span></span><br><span class="line">key_c = <span class="string">&#x27;&lt;&gt;&#123;&#125;:&quot;&#x27;</span></span><br><span class="line">secret = key_a * <span class="number">4</span> + <span class="string">&#x27;|&#x27;</span> + (key_b + key_a + key_c)*<span class="number">2</span> + <span class="string">&#x27;|&#x27;</span> + key_b*<span class="number">2</span> + <span class="string">&#x27;EOF&#x27;</span></span><br><span class="line"></span><br><span class="line">rot = rotor.newrotor(secret)</span><br><span class="line"><span class="built_in">print</span>(rot.decrypt(<span class="built_in">open</span>(<span class="string">&#x27;encrypted_flag&#x27;</span>, <span class="string">&#x27;rb&#x27;</span>).read()))</span><br></pre></td></tr></table></figure>

<p>最后得到答案：flag{Gue55_opcode_G@@@me}</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p>python字节码 <a href="http://www.bravegnu.org/blog/python-byte-code-hacks.html">http://www.bravegnu.org/blog/python-byte-code-hacks.html</a><br>opcode参考 <a href="http://unpyc.sourceforge.net/Opcodes.html">http://unpyc.sourceforge.net/Opcodes.html</a></p>
</div><div><ul class="post-copyright"><li class="post-copyright-author"><strong>本文作者：</strong>ss</li><li class="post-copyright-link"><strong>本文链接：</strong><a href="/2019/08/03/实验吧-py137/">https://ssdemajia.github.io/2019/08/03/%E5%AE%9E%E9%AA%8C%E5%90%A7-py137/</a></li><li class="post-copyright-license"><strong>版权声明：</strong>本站所有文章除特别声明外，均采用 <a href="http://creativecommons.org/licenses/by-nc-sa/3.0/cn/" rel="external nofollow" target="_blank">CC BY-NC-SA 3.0 CN</a> 许可协议。转载请注明出处！</li></ul></div><br><div class="tags"><a href="../../../../tags/ctf/">ctf</a></div><div class="post-nav"><a class="pre" href="../../10/%E8%87%AA%E5%88%B6%E8%AF%84%E8%AE%BA%E6%8F%92%E4%BB%B6/">自制评论插件</a><a class="next" href="../../../07/26/shellcode%E7%BC%96%E5%86%99/">shellcode编写</a></div><div id="comments"><div id="disqus_thread"><div class="btn_click_load"><button class="disqus_click_btn">阅读评论（请确保 Disqus 可以正常加载）</button></div><script type="text/javascript">var disqus_config = function () {
    this.page.url = 'https://ssdemajia.github.io/2019/08/03/实验吧-py137/';
    this.page.identifier = '2019/08/03/实验吧-py137/';
    this.page.title = '实验吧 py137';
  };</script><script type="text/javascript" id="disqus-lazy-load-script">$.ajax({
url: 'https://disqus.com/next/config.json',
timeout: 2500,
type: 'GET',
success: function(){
  var d = document;
  var s = d.createElement('script');
  s.src = '//dowob.disqus.com/embed.js';
  s.setAttribute('data-timestamp', + new Date());
  (d.head || d.body).appendChild(s);
  $('.disqus_click_btn').css('display', 'none');
},
error: function() {
  $('.disqus_click_btn').css('display', 'block');
}
});</script><script type="text/javascript" id="disqus-click-load">$('.btn_click_load').click(() => {  //click to load comments
    (() => { // DON'T EDIT BELOW THIS LINE
        var d = document;
        var s = d.createElement('script');
        s.src = '//dowob.disqus.com/embed.js';
        s.setAttribute('data-timestamp', + new Date());
        (d.head || d.body).appendChild(s);
    })();
    $('.disqus_click_btn').css('display','none');
});</script><script type="text/javascript" id="disqus-count-script">$(function() {
     var xhr = new XMLHttpRequest();
     xhr.open('GET', '//disqus.com/next/config.json', true);
     xhr.timeout = 2500;
     xhr.onreadystatechange = function () {
       if (xhr.readyState === 4 && xhr.status === 200) {
         $('.post-meta .post-comments-count').show();
         var s = document.createElement('script');
         s.id = 'dsq-count-scr';
         s.src = 'https://dowob.disqus.com/count.js';
         s.async = true;
         (document.head || document.body).appendChild(s);
       }
     };
     xhr.ontimeout = function () { xhr.abort(); };
     xhr.send(null);
   });  </script></div></div></div></div></div><div class="pure-u-1 pure-u-md-4"><div id="footer">Copyright © 2024 <a href="../../../../." rel="nofollow">SS.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/ssdemajia"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/ssdemajia"> SS.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="../../../../js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="../../../../js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="../../../../js/smartresize.js?v=0.0.0"></script></div></body></html>