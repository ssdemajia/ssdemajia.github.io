<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>python rq worker | SS</title><link rel="stylesheet" type="text/css" href="../../../../css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/normalize/8.0.1/normalize.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//lib.baomitu.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//lib.baomitu.com/jquery/3.3.1/jquery.min.js"></script><link rel="icon" mask="" sizes="any" href="../../../../favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="../../../../favicon.ico"><link rel="apple-touch-icon" href="../../../../apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="../../../../apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="../../../../atom.xml"><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
ga('create','UA-134074056-1','auto');ga('send','pageview');</script><meta name="generator" content="Hexo 7.3.0"></head><body><div class="body_container"><div id="header"><div class="site-name"><a id="logo" href="../../../../.">SS</a><p class="description">ä¸çŸ¥é“åœ¨è¯´äº›ä»€ä¹ˆ</p></div><div id="nav-menu"><a class="current" href="../../../../."><i class="fa undefined"> é¦–é¡µ</i></a><a href="../../../../archives/"><i class="fa undefined"> å½’æ¡£</i></a><a href="../../../../about/"><i class="fa undefined"> å…³äº</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-4"><div class="content_container"><div class="post"><h1 class="post-title">python rq worker</h1><div class="post-meta">May 29, 2019<span> | </span><span class="category"><a href="../../../../categories/%F0%9F%90%8Dpython/">ğŸpython</a></span><script src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> é˜…è¯»</span></span><span class="post-time"><span class="post-meta-item-text"> | </span><span class="post-meta-item-icon"><i class="fa fa-keyboard-o"></i><span class="post-count"> 2k</span><span class="post-meta-item-text"> å­—</span></span></span><span class="post-time"> | <span class="post-meta-item-icon"><i class="fa fa-hourglass-half"></i><span class="post-count"> 9</span><span class="post-meta-item-text"> åˆ†é’Ÿ</span></span></span></div><div class="post-content"><p>åœ¨åšé¡¹ç›®çš„æ—¶å€™é‡åˆ°è¿‡ä¸€ä¸ªé—®é¢˜å°±æ˜¯åŒä¸€ä¸ªworkeræ— æ³•å¹¶è¡Œçš„æ‰§è¡Œå¤šä¸ªä»»åŠ¡é˜Ÿåˆ—çš„ä»»åŠ¡ï¼Œæˆ‘æƒ³çœ‹çœ‹æºç é‡Œæ˜¯ä»€ä¹ˆåŸå› å¯¼è‡´å‡ºç°è¿™ä¸ªç»“æœã€‚</p>
<h2 id="å¯åŠ¨Worker"><a href="#å¯åŠ¨Worker" class="headerlink" title="å¯åŠ¨Worker"></a>å¯åŠ¨Worker</h2><p>éœ€è¦åœ¨å‘½ä»¤è¡Œå†…è¾“å…¥<code>rq worker</code></p>
<p>åœ¨<code>rq/cli.py</code>çš„workerå‡½æ•°æ‰§è¡Œå‘½ä»¤è¡Œå‚æ•°è§£æç­‰æ“ä½œï¼Œå…³é”®ä»£ç åœ¨<code>tryâ€¦catch</code>ä¸­ã€‚</p>
<ol>
<li>é¦–å…ˆæ‰§è¡Œ<code>cleanup_ghosts</code>ï¼Œå½“rqè¢«çªç„¶ç»ˆæ­¢æ—¶ï¼Œä¼šæ²¡æœ‰æ—¶é—´æ¸…ç†æ³¨å†Œçš„workerï¼Œè¿™ä¸ªå‡½æ•°ä¼šåœ¨å¼€å§‹æ—¶æ¸…é™¤ttlè¶…æ—¶çš„workerï¼Œä¸ç„¶ä¼šåœ¨worker infoé‡Œé¢è¿˜æ˜¾ç¤ºã€‚</li>
<li>ç„¶åå°†è‡ªå®šä¹‰çš„å¼‚å¸¸å¤„ç†å¯¼å…¥</li>
<li>åˆ›å»ºç›¸è¿çš„queueå¯¹è±¡</li>
<li>åˆ›å»ºworkerå¯¹è±¡</li>
<li>è°ƒç”¨workerçš„workæ–¹æ³•ï¼Œå¼€å§‹å¾ªç¯æ‰§è¡Œä»»åŠ¡</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">worker</span>(<span class="params">cli_config, burst, logging_level, name, results_ttl,</span></span><br><span class="line"><span class="params">           worker_ttl, job_monitoring_interval, verbose, quiet, sentry_dsn,</span></span><br><span class="line"><span class="params">           exception_handler, pid, queues, log_format, date_format, **options</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Starts an RQ worker.&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    settings = read_config_file(cli_config.config) <span class="keyword">if</span> cli_config.config <span class="keyword">else</span> &#123;&#125;</span><br><span class="line">    <span class="comment"># Worker specific default arguments</span></span><br><span class="line">    queues = queues <span class="keyword">or</span> settings.get(<span class="string">&#x27;QUEUES&#x27;</span>, [<span class="string">&#x27;default&#x27;</span>])</span><br><span class="line">    name = name <span class="keyword">or</span> settings.get(<span class="string">&#x27;NAME&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> pid:</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(os.path.expanduser(pid), <span class="string">&quot;w&quot;</span>) <span class="keyword">as</span> fp:</span><br><span class="line">            fp.write(<span class="built_in">str</span>(os.getpid()))</span><br><span class="line"></span><br><span class="line">    setup_loghandlers_from_args(verbose, quiet, date_format, log_format)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line"></span><br><span class="line">        cleanup_ghosts(cli_config.connection)</span><br><span class="line">        exception_handlers = []</span><br><span class="line">        <span class="keyword">for</span> h <span class="keyword">in</span> exception_handler:</span><br><span class="line">            exception_handlers.append(import_attribute(h))</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> is_suspended(cli_config.connection):</span><br><span class="line">            click.secho(<span class="string">&#x27;RQ is currently suspended, to resume job execution run &quot;rq resume&quot;&#x27;</span>, fg=<span class="string">&#x27;red&#x27;</span>)</span><br><span class="line">            sys.exit(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">        queues = [cli_config.queue_class(queue,</span><br><span class="line">                                         connection=cli_config.connection,</span><br><span class="line">                                         job_class=cli_config.job_class)</span><br><span class="line">                  <span class="keyword">for</span> queue <span class="keyword">in</span> queues]</span><br><span class="line">        worker = cli_config.worker_class(queues,</span><br><span class="line">                                         name=name,</span><br><span class="line">                                         connection=cli_config.connection,</span><br><span class="line">                                         default_worker_ttl=worker_ttl,</span><br><span class="line">                                         default_result_ttl=results_ttl,</span><br><span class="line">                                         job_monitoring_interval=job_monitoring_interval,</span><br><span class="line">                                         job_class=cli_config.job_class,</span><br><span class="line">                                         queue_class=cli_config.queue_class,</span><br><span class="line">                                         exception_handlers=exception_handlers <span class="keyword">or</span> <span class="literal">None</span>)</span><br><span class="line"></span><br><span class="line">        worker.work(burst=burst, logging_level=logging_level, date_format=date_format, log_format=log_format)</span><br><span class="line">    <span class="keyword">except</span> ConnectionError <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(e)</span><br><span class="line">        sys.exit(<span class="number">1</span>)</span><br></pre></td></tr></table></figure>

<h2 id="ä»»åŠ¡è·å–"><a href="#ä»»åŠ¡è·å–" class="headerlink" title="ä»»åŠ¡è·å–"></a>ä»»åŠ¡è·å–</h2><p>ä»»åŠ¡æ‰§è¡Œçš„å…¥å£æ˜¯worker.pyçš„workæ–¹æ³•ã€‚æ•´ä¸ªworkeræ–¹æ³•æ˜¯ä¸€ä¸ªä¸ç»ˆæ­¢çš„å¾ªç¯ï¼Œä¸æ–­çš„ä»é˜Ÿåˆ—ä¸­å–å‡ºä»»åŠ¡ï¼Œç„¶åæ‰§è¡Œã€‚</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">work</span>(<span class="params">self, burst=<span class="literal">False</span>, logging_level=<span class="string">&quot;INFO&quot;</span>, date_format=DEFAULT_LOGGING_DATE_FORMAT,</span></span><br><span class="line"><span class="params">         log_format=DEFAULT_LOGGING_FORMAT</span>):</span><br><span class="line">    <span class="variable language_">self</span>._install_signal_handlers()  <span class="comment"># æ³¨å†Œä¿¡å·å¤„ç†å‡½æ•°</span></span><br><span class="line">    did_perform_work = <span class="literal">False</span></span><br><span class="line">    <span class="variable language_">self</span>.register_birth()	 <span class="comment"># å‘redisæ³¨å†Œæ—¥æœŸ</span></span><br><span class="line">    <span class="variable language_">self</span>.set_state(WorkerStatus.STARTED)</span><br><span class="line">    qnames = <span class="variable language_">self</span>.queue_names()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="variable language_">self</span>.check_for_suspension(burst)</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> <span class="variable language_">self</span>.should_run_maintenance_tasks:</span><br><span class="line">                    <span class="variable language_">self</span>.clean_registries()</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> <span class="variable language_">self</span>._stop_requested:</span><br><span class="line">                    <span class="variable language_">self</span>.log.info(<span class="string">&#x27;Stopping on request&#x27;</span>)</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">                timeout = <span class="literal">None</span> <span class="keyword">if</span> burst <span class="keyword">else</span> <span class="built_in">max</span>(<span class="number">1</span>, <span class="variable language_">self</span>.default_worker_ttl - <span class="number">15</span>)</span><br><span class="line"></span><br><span class="line">                result = <span class="variable language_">self</span>.dequeue_job_and_maintain_ttl(timeout)</span><br><span class="line">                <span class="keyword">if</span> result <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">                    <span class="keyword">if</span> burst:</span><br><span class="line">                        <span class="variable language_">self</span>.log.info(<span class="string">&quot;RQ worker %r done, quitting&quot;</span>, <span class="variable language_">self</span>.key)</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">                job, queue = result</span><br><span class="line">                <span class="variable language_">self</span>.execute_job(job, queue)  <span class="comment"># æ‰§è¡Œä»»åŠ¡</span></span><br><span class="line">                <span class="variable language_">self</span>.heartbeat()</span><br><span class="line"></span><br><span class="line">                did_perform_work = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">except</span> StopRequested:</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="variable language_">self</span>.is_horse:</span><br><span class="line">            <span class="variable language_">self</span>.register_death()</span><br><span class="line">    <span class="keyword">return</span> did_perform_work</span><br></pre></td></tr></table></figure>

<ol>
<li><p>é¦–å…ˆæ³¨å†Œä¿¡å·å¤„ç†å‡½æ•°ï¼Œå¤„ç†ä¸­æ–­è¿›ç¨‹å’Œç»ˆæ­¢è¿›ç¨‹å‡½æ•°ã€‚</p>
</li>
<li><p>ç„¶ååœ¨register_birth()ä¸­ï¼Œå°†å½“å‰workerçš„keyï¼ˆæ¯”å¦‚rq:worker:shaoshuaideMacBook-Pro.21131ï¼‰ä½œä¸ºä¸€ä¸ªhashmapä¿å­˜ï¼Œè¿™ä¸ªhashmapé‡Œä¿å­˜äº†workerçš„åˆ›å»ºæ—¶é—´ã€workerçš„last heart beatã€ä¾èµ–çš„é˜Ÿåˆ—ä»¬ï¼ˆé»˜è®¤æ˜¯defaulté˜Ÿåˆ—åï¼‰ã€‚æœ€åé€šè¿‡<code>worker_registration.register(self, p)</code>å°†è¿™ä¸ªworkerçš„keyæ”¾å…¥é˜Ÿåˆ—æ‰€æ‹¥æœ‰çš„setä¸­ã€‚è¿™æ ·èƒ½å¤Ÿå¿«é€ŸæŸ¥åˆ°å½“å‰é˜Ÿåˆ—æœ‰å“ªäº›workeråœ¨ä½¿ç”¨ã€‚</p>
</li>
<li><p>åœ¨workerå¯¹åº”çš„hashmapé‡Œæ·»åŠ çŠ¶æ€<code>&#123;state: &quot;started&quot;&#125;</code></p>
</li>
<li><p>è¿›å…¥è¶…å¤§<code>while True</code>å¾ªç¯ä¸­</p>
<ul>
<li><p>é¦–å…ˆ<code>check_for_suspension</code>, åˆ¤æ–­æ˜¯å¦æ”¶åˆ°æš‚åœå‘½ä»¤ã€‚æš‚åœæ ‡å¿—æ˜¯ä¿å­˜åœ¨redisä¸­keyä¸º<code>rq:suspended</code>ï¼Œå¦‚æœéœ€è¦æš‚åœï¼Œåˆ™åœ¨å‡½æ•°<code>check_for_suspension</code>ä¸­ä¸æ–­ä¼‘çœ ã€‚</p>
</li>
<li><p>ä»é˜Ÿåˆ—ä¸­è·å–ä¸€ä¸ªä»»åŠ¡ï¼Œä½¿ç”¨redis <code>BLPOP é˜Ÿåˆ—1 é˜Ÿåˆ—2 ... é˜Ÿåˆ—N</code>å·¦è¾¹å‡ºé˜Ÿä¸€ä¸ªJobï¼Œè¿™é‡Œä½¿ç”¨<code>BLPOP</code>æ‰€ä»¥è®¾å®šäº†è¶…æ—¶æ—¶é—´ï¼ŒåŒæ—¶redisä¿è¯äº†æ£€æŸ¥é¡ºåºï¼ŒæŒ‰ç…§é˜Ÿåˆ—1-&gt;é˜Ÿåˆ—2-&gt;é˜Ÿåˆ—3ã€‚</p>
</li>
<li><p>å°†ä»»åŠ¡äº¤ç»™workeræ‰§è¡Œï¼Œ<code>self.execute_job(job, queue)</code></p>
</li>
</ul>
</li>
</ol>
<h2 id="ä»»åŠ¡æ‰§è¡Œ"><a href="#ä»»åŠ¡æ‰§è¡Œ" class="headerlink" title="ä»»åŠ¡æ‰§è¡Œ"></a>ä»»åŠ¡æ‰§è¡Œ</h2><ol>
<li>é¦–å…ˆå°†ä»»åŠ¡è®¾ç½®ä¸ºBUSYï¼Œæ­¤æ—¶workerçš„çŠ¶æ€å¦‚ä¸‹</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; HGETALL rq:worker:shaoshuaideMacBook-Pro.21131</span><br><span class="line">1) &quot;state&quot;</span><br><span class="line">2) &quot;busy&quot;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li><p>è°ƒç”¨<code>fork_work_horse(job, queue)</code>ï¼Œåœ¨è¿™ä¸ªå‡½æ•°ä¸­è°ƒç”¨<code>os.fork()</code>ï¼Œå› æ­¤åœ¨windowsä¸­<code>python rq</code>æ˜¯ç”¨ä¸äº†çš„ã€‚</p>
<ul>
<li><p>å¯¹äºå­è¿›ç¨‹ï¼Œç»§ç»­æ‰§è¡Œ<code>self.main_work_horse(job, queue)</code></p>
</li>
<li><p>å¯¹äºçˆ¶è¿›ç¨‹ï¼Œä¿å­˜å­è¿›ç¨‹çš„pidå°±é€€å‡ºäº†<code>fork_work_horse</code>äº†</p>
</li>
</ul>
</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">execute_job</span>(<span class="params">self, job, queue</span>):</span><br><span class="line">    <span class="variable language_">self</span>.set_state(WorkerStatus.BUSY)</span><br><span class="line">    <span class="variable language_">self</span>.fork_work_horse(job, queue)  <span class="comment"># è¿™é‡Œæ˜¯å­è¿›ç¨‹æ‰§è¡Œ</span></span><br><span class="line">    <span class="variable language_">self</span>.monitor_work_horse(job)  <span class="comment"># è¿™é‡Œæ˜¯çˆ¶è¿›ç¨‹æ‰§è¡Œ</span></span><br><span class="line">    <span class="variable language_">self</span>.set_state(WorkerStatus.IDLE)</span><br></pre></td></tr></table></figure>

<h3 id="å­è¿›ç¨‹æ‰§è¡Œ"><a href="#å­è¿›ç¨‹æ‰§è¡Œ" class="headerlink" title="å­è¿›ç¨‹æ‰§è¡Œ"></a>å­è¿›ç¨‹æ‰§è¡Œ</h3><p>æ­¤æ—¶å­è¿›ç¨‹è¿›å…¥<code>main_work_horse</code>ã€‚</p>
<ol>
<li><p>é¦–å…ˆè®¾ç½®å¿½ç•¥SIGINTä¸­æ–­ä¿¡å·ï¼ˆä¹Ÿå°±æ˜¯ctrl+cï¼‰ï¼Œä¹Ÿå°±æ˜¯è¯´å½“å‰çš„workä¼šå®Œæˆï¼Œå†é€€å‡ºrqã€‚åŒæ—¶è®¾ç½®SIGTERMä¿¡å·ä¸ºé»˜è®¤å¤„ç†å‡½æ•°ï¼ˆä¹Ÿå°±æ˜¯ç›´æ¥é€€å‡ºï¼‰ï¼Œå³cold shutdownã€‚</p>
</li>
<li><p>åœ¨<code>self.perform_job(job, queue)</code>ä¸­æ‰§è¡Œä»»åŠ¡ã€‚</p>
<ul>
<li>é¦–å…ˆæ›´æ–°workerçŠ¶æ€ï¼š</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; HGETALL rq:worker:shaoshuaideMacBook-Pro.21131</span><br><span class="line">1) &quot;state&quot;</span><br><span class="line">2) &quot;busy&quot;</span><br><span class="line">3) &quot;current_job&quot;</span><br><span class="line">4) &quot;8407214b-7cab-4fd4-b409-acfdc5676920&quot;</span><br><span class="line">5) &quot;last_heartbeat&quot;</span><br><span class="line">6) &quot;2019-05-30T07:36:58.802853Z&quot;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li><p>redisçš„<code>rq:wip:default</code>ä¸­ä¿å­˜äº†å½“å‰è¿è¡Œçš„ä»»åŠ¡IDã€‚</p>
</li>
<li><p>ç„¶ååœ¨timeoutçš„æ—¶é—´å†…è¿è¡Œ</p>
</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> <span class="variable language_">self</span>.death_penalty_class(timeout, JobTimeoutException, job_id=job.<span class="built_in">id</span>):</span><br><span class="line">	rv = job.perform()</span><br></pre></td></tr></table></figure>

<ul>
<li><p>å°†è¯¥ä»»åŠ¡çš„ttlå»é™¤ï¼Œç„¶åè°ƒç”¨jobçš„<code>self._execute()</code> &#x3D;&gt; è°ƒç”¨<code>self.func</code> ï¼Œå…¶ä¸­self.funcæ˜¯ä¸€ä¸ªå±æ€§è£…é¥°å™¨çš„å‡½æ•°ï¼Œè¿”å›ä¸€ä¸ªéœ€è¦æ‰§è¡Œçš„å‡½æ•°&#x3D;&gt; è°ƒç”¨<code>import_attribute(self.func_name)</code>&#x3D;&gt;å¯¼å…¥ç›¸å…³å‡½æ•°åæ‰§è¡Œ<code>(*self.args, **self.kwargs)</code>ã€‚</p>
</li>
<li><p>æ‰§è¡Œç»“æŸååœ¨redisä¸­åˆ é™¤å¯¹åº”çš„ä¾èµ–jobä¿¡æ¯ï¼Œä¿®æ”¹workerçš„ä¸€äº›ç»Ÿè®¡ä¿¡æ¯ï¼Œæ¯”å¦‚å°†å½“å‰çš„ä»»åŠ¡å¯¹è±¡è®¾ä¸ºNoneã€å°†æˆåŠŸçš„ä»»åŠ¡æ•°åŠ ä¸€ã€å¢åŠ ä»»åŠ¡æ€»æ‰§è¡Œæ—¶é—´ã€ä¿å­˜ä»»åŠ¡æ‰§è¡Œçš„ä¿¡æ¯ï¼Œä¸‹é¢æ˜¯å½“å‰å®Œæˆä»»åŠ¡çš„ä¿¡æ¯ã€‚</p>
</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; hgetall rq:job:4d73fa5a-562a-4761-a3ca-393c66b2fe49</span><br><span class="line"> 1) &quot;status&quot;</span><br><span class="line"> 2) &quot;started&quot;</span><br><span class="line"> 3) &quot;created_at&quot;</span><br><span class="line"> 4) &quot;2019-05-30T07:51:53.446755Z&quot;</span><br><span class="line"> 5) &quot;data&quot;</span><br><span class="line"> 6) &quot;x\x9ck`\x99*\xce\x00\x01\x1a=&lt;%\xa9\xc5%\xf1E\xa5yz\x05\x05\x05S\xfc4k\xa7\x94L\xd1\x03\x00\x8f\x11\n5&quot;</span><br><span class="line"> 7) &quot;origin&quot;</span><br><span class="line"> 8) &quot;default&quot;</span><br><span class="line"> 9) &quot;description&quot;</span><br><span class="line">10) &quot;test_run.ppp()&quot;</span><br><span class="line">11) &quot;enqueued_at&quot;</span><br><span class="line">12) &quot;2019-05-30T07:51:53.447650Z&quot;</span><br><span class="line">13) &quot;timeout&quot;</span><br><span class="line">14) &quot;180&quot;</span><br><span class="line">15) &quot;started_at&quot;</span><br><span class="line">16) &quot;2019-05-30T07:53:36.856964Z&quot;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>å°†jobæ”¾å…¥<code>rq:finished:default</code>ä¸­ï¼ŒåŒæ—¶ä¸ºä»»åŠ¡ç»“æœè®¾ç½®è¶…æ—¶æ—¶é—´ã€‚</p>
</li>
<li><p>æœ€å<code>os._exit(0)</code>ï¼Œå­è¿›ç¨‹å®Œç¾æ‰§è¡Œç»“æŸã€‚</p>
</li>
</ul>
</li>
</ol>
<h3 id="çˆ¶è¿›ç¨‹æ‰§è¡Œ"><a href="#çˆ¶è¿›ç¨‹æ‰§è¡Œ" class="headerlink" title="çˆ¶è¿›ç¨‹æ‰§è¡Œ"></a>çˆ¶è¿›ç¨‹æ‰§è¡Œ</h3><p>çˆ¶è¿›ç¨‹åœ¨è·å–å­è¿›ç¨‹pidåï¼Œå¼€å§‹æ‰§è¡Œ<code>monitor_work_horse(job)</code>ã€‚çˆ¶è¿›ç¨‹ä¼šè°ƒç”¨<code>os.waitpid(self._horse_pid, 0)</code>æ¥ç­‰å¾…å­è¿›ç¨‹å®Œæˆã€‚</p>
<h2 id="å¤„ç†è¶…æ—¶"><a href="#å¤„ç†è¶…æ—¶" class="headerlink" title="å¤„ç†è¶…æ—¶"></a>å¤„ç†è¶…æ—¶</h2><h3 id="workerå¿ƒè·³æœºåˆ¶"><a href="#workerå¿ƒè·³æœºåˆ¶" class="headerlink" title="workerå¿ƒè·³æœºåˆ¶"></a>workerå¿ƒè·³æœºåˆ¶</h3><p>å¯¹äºworkeræ¥è¯´ï¼Œæ¯æ¬¡è·å–ä»»åŠ¡å‰ä¼šè°ƒç”¨<code>heartbeat(timeout, pipeline)</code>æ¥æ›´æ–°å½“å‰workerè¿™ä¸ªkeyçš„ttlï¼Œæ¥é˜²æ­¢workerè¶…æ—¶ã€‚é»˜è®¤çš„ttlæ˜¯420ç§’ã€‚åŒæ—¶åœ¨<code>prepare_job_execution</code>å‰ä¹Ÿä¼šæ›´æ–°<code>heartbeat()</code>ï¼Œè¿™ä¸ªä¸»è¦æ˜¯ç”¨äºdashboardåˆ¤æ–­è¿™ä¸ªworkeræ˜¯ä¸æ˜¯æ— å“åº”ã€‚</p>
<h3 id="jobè¶…æ—¶å¤„ç†"><a href="#jobè¶…æ—¶å¤„ç†" class="headerlink" title="jobè¶…æ—¶å¤„ç†"></a>jobè¶…æ—¶å¤„ç†</h3><p>åœ¨å­è¿›ç¨‹æ‰§è¡Œç›®æ ‡ä»»åŠ¡æ—¶ï¼ˆ<code>main_work_horse</code>&#x3D;&gt;<code>perform_job</code>&#x3D;&gt;<code>job.perform</code>ä¸­ï¼‰ï¼Œä¼šåœ¨å‰é¢åŠ ä¸Šä¸‹æ–‡ç®¡ç†å™¨</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> <span class="variable language_">self</span>.death_penalty_class(timeout, JobTimeoutException, job_id=job.<span class="built_in">id</span>):</span><br><span class="line">	rv = job.perform()</span><br></pre></td></tr></table></figure>

<p><code>self.death_penalty_class</code>vu ä¸º<code>UnixSignalDeathPenalty</code>ç»§æ‰¿è‡ª<code>BaseDeathPenalty</code>ï¼Œä¸»è¦æ˜¯åœ¨enteræ–¹æ³•ä¸­æ³¨å†Œé’ˆå¯¹SIGALRMä¿¡å·çš„å¤„ç†å‡½æ•°ï¼Œä½¿ç”¨<code>signal.alarmï¼ˆself._timeout)</code>åœ¨é»˜è®¤çš„180ç§’åå‘å‡ºSIGALRMä¿¡å·ï¼Œä¹‹åæŠ›å‡ºå¼‚å¸¸ã€‚</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">UnixSignalDeathPenalty</span>(<span class="title class_ inherited__">BaseDeathPenalty</span>):</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">handle_death_penalty</span>(<span class="params">self, signum, frame</span>):</span><br><span class="line">        <span class="keyword">raise</span> <span class="variable language_">self</span>._exception(<span class="string">&#x27;Task exceeded maximum timeout value &#x27;</span></span><br><span class="line">                              <span class="string">&#x27;(&#123;0&#125; seconds)&#x27;</span>.<span class="built_in">format</span>(<span class="variable language_">self</span>._timeout))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">setup_death_penalty</span>(<span class="params">self</span>):</span><br><span class="line">        signal.signal(signal.SIGALRM, <span class="variable language_">self</span>.handle_death_penalty)</span><br><span class="line">        signal.alarm(<span class="variable language_">self</span>._timeout)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">cancel_death_penalty</span>(<span class="params">self</span>):</span><br><span class="line">        signal.alarm(<span class="number">0</span>)</span><br><span class="line">        signal.signal(signal.SIGALRM, signal.SIG_DFL)</span><br><span class="line">        </span><br><span class="line"><span class="keyword">class</span> <span class="title class_">BaseDeathPenalty</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, timeout, exception=JobTimeoutException, **kwargs</span>):</span><br><span class="line">        <span class="variable language_">self</span>._timeout = timeout</span><br><span class="line">        <span class="variable language_">self</span>._exception = exception</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__enter__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="variable language_">self</span>.setup_death_penalty()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__exit__</span>(<span class="params">self, <span class="built_in">type</span>, value, traceback</span>):</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="variable language_">self</span>.cancel_death_penalty()</span><br><span class="line">        <span class="keyword">except</span> BaseTimeoutException:</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">setup_death_penalty</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">raise</span> NotImplementedError()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">cancel_death_penalty</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">raise</span> NotImplementedError()</span><br></pre></td></tr></table></figure>

<p>å¦‚æœjobè¿è¡Œå‡ºç°å¼‚å¸¸å°†ä»»åŠ¡è®¾ä¸ºFailedã€ä»startedé˜Ÿåˆ—ä¸­åˆ é™¤ä»»åŠ¡ã€å¢åŠ ä»»åŠ¡å¤±è´¥æ¬¡æ•°ã€å°†é”™è¯¯ä¿¡æ¯è¾“å‡ºã€‚</p>
<h2 id="ç»“æŸworker"><a href="#ç»“æŸworker" class="headerlink" title="ç»“æŸworker"></a>ç»“æŸworker</h2><p>åœ¨workerçš„workæ–¹æ³•ä¸­ä½¿ç”¨<code>self._install_signal_handlers()</code>æ³¨å†Œäº†é’ˆå¯¹SIGINTã€SIGTERMçš„handler self.request_stopã€‚æ­¤æ—¶æ”¶åˆ°äº†ä¸€ä¸ªCtrl+Cï¼Œä¼šè¿›å…¥request_stopæ¥å¤„ç†ä¿¡å·ã€‚</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">request_stop</span>(<span class="params">self, signum, frame</span>):</span><br><span class="line">    signal.signal(signal.SIGINT, <span class="variable language_">self</span>.request_force_stop)</span><br><span class="line">    signal.signal(signal.SIGTERM, <span class="variable language_">self</span>.request_force_stop)</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">self</span>.handle_warm_shutdown_request()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="variable language_">self</span>.get_state() == WorkerStatus.BUSY:</span><br><span class="line">        <span class="variable language_">self</span>._stop_requested = <span class="literal">True</span></span><br><span class="line">        <span class="variable language_">self</span>.set_shutdown_requested_date()</span><br><span class="line">        <span class="variable language_">self</span>.log.debug(<span class="string">&#x27;Stopping after current horse is finished. &#x27;</span></span><br><span class="line">                       <span class="string">&#x27;Press Ctrl+C again for a cold shutdown.&#x27;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">raise</span> StopRequested()</span><br></pre></td></tr></table></figure>

<p>åœ¨è¿™ä¸ªæ–¹æ³•ä¸­ï¼Œä¼šé‡æ–°ä¸ºSIGINTã€SIGTERMç»‘å®šæ–°çš„å¤„ç†æ–¹æ³•self.request_force_stopã€‚</p>
<ol>
<li>å¦‚æœå†æ¬¡Ctrl+Cï¼Œä¼šcold shutdownï¼Œå¦‚æœå­è¿›ç¨‹è¿˜åœ¨è¿è¡Œï¼Œä¼šç›´æ¥killå®ƒã€‚</li>
<li>å¦åˆ™è¿›è¡Œwarn shutdownï¼Œå¦‚æœå­è¿›ç¨‹è¿˜åœ¨è¿è¡Œï¼Œè®¾ç½®self._stop_reqestedï¼Œåˆ™ä¸ä¼šç»§ç»­ä»é˜Ÿåˆ—è·å–ä»»åŠ¡ï¼ŒåŒæ—¶ç­‰å¾…å­è¿›ç¨‹è¿è¡Œå®Œæ¯•ã€‚</li>
</ol>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>é€šè¿‡ä¸Šé¢çš„åˆ†æï¼Œè™½ç„¶æˆ‘æŒ‡å®šå½“å‰workerä»å‡ ä¸ªqueueä¸­è·å–ä»»åŠ¡ï¼Œä½†æ˜¯rqçš„workeråªåœ¨ä¸€ä¸ªè¿›ç¨‹ä¸­æ‰§è¡Œï¼Œæ¯æ¬¡åªæ‰§è¡Œä¸€ä¸ªJobã€‚ä¸ºäº†èƒ½å¤Ÿå¹¶è¡Œï¼Œå¯¹éœ€è¦å¹¶è¡Œçš„ä»»åŠ¡å¤šå¼€workerã€‚</p>
</div><div><ul class="post-copyright"><li class="post-copyright-author"><strong>æœ¬æ–‡ä½œè€…ï¼š</strong>ss</li><li class="post-copyright-link"><strong>æœ¬æ–‡é“¾æ¥ï¼š</strong><a href="/2019/05/29/python-rq-worker/">https://ssdemajia.github.io/2019/05/29/python-rq-worker/</a></li><li class="post-copyright-license"><strong>ç‰ˆæƒå£°æ˜ï¼š</strong>æœ¬ç«™æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ <a href="http://creativecommons.org/licenses/by-nc-sa/3.0/cn/" rel="external nofollow" target="_blank">CC BY-NC-SA 3.0 CN</a> è®¸å¯åè®®ã€‚è½¬è½½è¯·æ³¨æ˜å‡ºå¤„ï¼</li></ul></div><br><div class="tags"></div><div class="post-nav"><a class="pre" href="../../../06/05/element-ui-button-border-layout-container-link/">element-ui button layout container input</a><a class="next" href="../../23/redis-pipelining/">redis pipelining</a></div><div id="comments"><div id="disqus_thread"><div class="btn_click_load"><button class="disqus_click_btn">é˜…è¯»è¯„è®ºï¼ˆè¯·ç¡®ä¿ Disqus å¯ä»¥æ­£å¸¸åŠ è½½ï¼‰</button></div><script type="text/javascript">var disqus_config = function () {
    this.page.url = 'https://ssdemajia.github.io/2019/05/29/python-rq-worker/';
    this.page.identifier = '2019/05/29/python-rq-worker/';
    this.page.title = 'python rq worker';
  };</script><script type="text/javascript" id="disqus-lazy-load-script">$.ajax({
url: 'https://disqus.com/next/config.json',
timeout: 2500,
type: 'GET',
success: function(){
  var d = document;
  var s = d.createElement('script');
  s.src = '//dowob.disqus.com/embed.js';
  s.setAttribute('data-timestamp', + new Date());
  (d.head || d.body).appendChild(s);
  $('.disqus_click_btn').css('display', 'none');
},
error: function() {
  $('.disqus_click_btn').css('display', 'block');
}
});</script><script type="text/javascript" id="disqus-click-load">$('.btn_click_load').click(() => {  //click to load comments
    (() => { // DON'T EDIT BELOW THIS LINE
        var d = document;
        var s = d.createElement('script');
        s.src = '//dowob.disqus.com/embed.js';
        s.setAttribute('data-timestamp', + new Date());
        (d.head || d.body).appendChild(s);
    })();
    $('.disqus_click_btn').css('display','none');
});</script><script type="text/javascript" id="disqus-count-script">$(function() {
     var xhr = new XMLHttpRequest();
     xhr.open('GET', '//disqus.com/next/config.json', true);
     xhr.timeout = 2500;
     xhr.onreadystatechange = function () {
       if (xhr.readyState === 4 && xhr.status === 200) {
         $('.post-meta .post-comments-count').show();
         var s = document.createElement('script');
         s.id = 'dsq-count-scr';
         s.src = 'https://dowob.disqus.com/count.js';
         s.async = true;
         (document.head || document.body).appendChild(s);
       }
     };
     xhr.ontimeout = function () { xhr.abort(); };
     xhr.send(null);
   });  </script></div></div></div></div></div><div class="pure-u-1 pure-u-md-4"><div id="footer">Copyright Â© 2024 <a href="../../../../." rel="nofollow">SS.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/ssdemajia"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/ssdemajia"> SS.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="../../../../js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="../../../../js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="../../../../js/smartresize.js?v=0.0.0"></script></div></body></html>