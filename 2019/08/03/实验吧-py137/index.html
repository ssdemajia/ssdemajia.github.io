<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>å®éªŒå§ py137 | SS</title><link rel="stylesheet" type="text/css" href="../../../../css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/normalize/8.0.1/normalize.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//lib.baomitu.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//lib.baomitu.com/jquery/3.3.1/jquery.min.js"></script><link rel="icon" mask="" sizes="any" href="../../../../favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="../../../../favicon.ico"><link rel="apple-touch-icon" href="../../../../apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="../../../../apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="../../../../atom.xml"><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
ga('create','UA-134074056-1','auto');ga('send','pageview');</script><meta name="generator" content="Hexo 7.3.0"></head><body><div class="body_container"><div id="header"><div class="site-name"><a id="logo" href="../../../../.">SS</a><p class="description">ä¸çŸ¥é“åœ¨è¯´äº›ä»€ä¹ˆ</p></div><div id="nav-menu"><a class="current" href="../../../../."><i class="fa undefined"> é¦–é¡µ</i></a><a href="../../../../archives/"><i class="fa undefined"> å½’æ¡£</i></a><a href="../../../../about/"><i class="fa undefined"> å…³äº</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-4"><div class="content_container"><div class="post"><h1 class="post-title">å®éªŒå§ py137</h1><div class="post-meta">Aug 3, 2019<span> | </span><span class="category"><a href="../../../../categories/%F0%9F%94%92%E5%AE%89%E5%85%A8/">ğŸ”’å®‰å…¨</a></span><script src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> é˜…è¯»</span></span><span class="post-time"><span class="post-meta-item-text"> | </span><span class="post-meta-item-icon"><i class="fa fa-keyboard-o"></i><span class="post-count"> 2.7k</span><span class="post-meta-item-text"> å­—</span></span></span><span class="post-time"> | <span class="post-meta-item-icon"><i class="fa fa-hourglass-half"></i><span class="post-count"> 14</span><span class="post-meta-item-text"> åˆ†é’Ÿ</span></span></span></div><div class="post-content"><p>æˆ‘ä¸€å¼€å§‹è¯•äº†è¯•uncompyle6ï¼Œç„¶è€Œå¹¶æ²¡æœ‰ä»€ä¹ˆç”¨ï¼Œæ„Ÿè§‰ä»£ç å¯èƒ½è¢«æ”¹äº†å¾ˆå¤šã€‚åé¢æœç´¢åˆ°äº†æ–¹æ³•ï¼Œæ¥è‡ª <a href="https://0xd13a.github.io/ctfs/0ctf2017/py/">https://0xd13a.github.io/ctfs/0ctf2017/py/</a></p>
<p>é¦–å…ˆé˜…è¯»<a href="https://nedbatchelder.com/blog/200804/the_structure_of_pyc_files.html">https://nedbatchelder.com/blog/200804/the_structure_of_pyc_files.html</a> ï¼Œäº†è§£åˆ°pycæ–‡ä»¶ç”±ä¸‰éƒ¨åˆ†ç»„æˆï¼Œåˆ†åˆ«æ˜¯magic codeï¼ˆ4å­—èŠ‚ï¼‰ã€æ—¶é—´æˆ³ï¼ˆ4å­—èŠ‚ï¼‰ã€marshalåçš„codeï¼ˆå‰©ä¸‹ï¼‰ç»„æˆã€‚ä½œè€…æä¾›äº†ä¸€ä¸ªåˆ©ç”¨disåº“ã€marshalåº“çš„ç¨‹åºã€‚</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># disassem.py</span></span><br><span class="line"><span class="keyword">import</span> dis, marshal, struct, sys, time, types</span><br><span class="line"><span class="keyword">import</span> roto</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show_file</span>(<span class="params">fname</span>):</span><br><span class="line">    f = <span class="built_in">open</span>(fname, <span class="string">&quot;rb&quot;</span>)</span><br><span class="line">    magic = f.read(<span class="number">4</span>)</span><br><span class="line">    moddate = f.read(<span class="number">4</span>)</span><br><span class="line">    modtime = time.asctime(time.localtime(struct.unpack(<span class="string">&#x27;I&#x27;</span>, moddate)[<span class="number">0</span>]))</span><br><span class="line">    <span class="built_in">print</span> <span class="string">&quot;magic %s&quot;</span> % (magic.encode(<span class="string">&#x27;hex&#x27;</span>))</span><br><span class="line">    <span class="built_in">print</span> <span class="string">&quot;moddate %s (%s)&quot;</span> % (moddate.encode(<span class="string">&#x27;hex&#x27;</span>), modtime)</span><br><span class="line">    code = marshal.load(f)</span><br><span class="line">    show_code(code)</span><br><span class="line">    </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show_code</span>(<span class="params">code, indent=<span class="string">&#x27;&#x27;</span></span>):</span><br><span class="line">    <span class="built_in">print</span> <span class="string">&quot;%scode&quot;</span> % indent</span><br><span class="line">    indent += <span class="string">&#x27;   &#x27;</span></span><br><span class="line">    <span class="built_in">print</span> <span class="string">&quot;%sargcount %d&quot;</span> % (indent, code.co_argcount)</span><br><span class="line">    <span class="built_in">print</span> <span class="string">&quot;%snlocals %d&quot;</span> % (indent, code.co_nlocals)</span><br><span class="line">    <span class="built_in">print</span> <span class="string">&quot;%sstacksize %d&quot;</span> % (indent, code.co_stacksize)</span><br><span class="line">    <span class="built_in">print</span> <span class="string">&quot;%sflags %04x&quot;</span> % (indent, code.co_flags)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;code length: %d&quot;</span> % (<span class="built_in">len</span>(code.co_code)))</span><br><span class="line">    show_hex(<span class="string">&quot;code&quot;</span>, code.co_code, indent=indent)</span><br><span class="line">    dis.disassemble(code)</span><br><span class="line">    <span class="built_in">print</span> <span class="string">&quot;%sconsts&quot;</span> % indent</span><br><span class="line">    <span class="keyword">for</span> const <span class="keyword">in</span> code.co_consts:</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">type</span>(const) == types.CodeType:</span><br><span class="line">            show_code(const, indent+<span class="string">&#x27;   &#x27;</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">print</span> <span class="string">&quot;   %s%r&quot;</span> % (indent, const)</span><br><span class="line">    <span class="built_in">print</span> <span class="string">&quot;%snames %r&quot;</span> % (indent, code.co_names)</span><br><span class="line">    <span class="built_in">print</span> <span class="string">&quot;%svarnames %r&quot;</span> % (indent, code.co_varnames)</span><br><span class="line">    <span class="built_in">print</span> <span class="string">&quot;%sfreevars %r&quot;</span> % (indent, code.co_freevars)</span><br><span class="line">    <span class="built_in">print</span> <span class="string">&quot;%scellvars %r&quot;</span> % (indent, code.co_cellvars)</span><br><span class="line">    <span class="built_in">print</span> <span class="string">&quot;%sfilename %r&quot;</span> % (indent, code.co_filename)</span><br><span class="line">    <span class="built_in">print</span> <span class="string">&quot;%sname %r&quot;</span> % (indent, code.co_name)</span><br><span class="line">    <span class="built_in">print</span> <span class="string">&quot;%sfirstlineno %d&quot;</span> % (indent, code.co_firstlineno)</span><br><span class="line">    show_hex(<span class="string">&quot;lnotab&quot;</span>, code.co_lnotab, indent=indent)</span><br><span class="line">    </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show_hex</span>(<span class="params">label, h, indent</span>):</span><br><span class="line">    h = h.encode(<span class="string">&#x27;hex&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(h) &lt; <span class="number">60</span>:</span><br><span class="line">        <span class="built_in">print</span> <span class="string">&quot;%s%s %s&quot;</span> % (indent, label, h)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span> <span class="string">&quot;%s%s&quot;</span> % (indent, label)</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(h), <span class="number">60</span>):</span><br><span class="line">            <span class="built_in">print</span> <span class="string">&quot;%s   %s&quot;</span> % (indent, h[i:i+<span class="number">60</span>])</span><br><span class="line"></span><br><span class="line">show_file(sys.argv[<span class="number">1</span>])</span><br></pre></td></tr></table></figure>

<p>ç„¶åæˆ‘æŠŠè¿™ä¸ªä»£ç æ”¹æˆpython3ï¼Œæ‰“å¼€<code>python3 disassem.py crypt.pyc</code>ï¼Œmarshalåº“ä¼šæŠ¥é”™ValueErrorï¼Œæ–‡æ¡£é‡Œé¢æ˜¾ç¤º:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">because the data has a different Python versionâ€™s incompatible marshal format), raise [`EOFError`](exceptions.html#EOFError), [`ValueError`](exceptions.html#ValueError) or [`TypeError`](exceptions.html#TypeError). The file must be a readable [binary file](../glossary.html#term-binary-file).`</span><br></pre></td></tr></table></figure>

<p>ä¹Ÿå°±æ˜¯marshalè¿™ä¸ªåº“ç›¸å¯¹äºpickleï¼Œä¸éœ€è¦æŒä¹…åŒ–å¾ˆä¹…ï¼Œæ‰€ä»¥å®ƒä¼šéšç€pythonç‰ˆæœ¬å‘ç”Ÿæ”¹å˜ã€‚å› ä¸ºmagic codeç”±4ä¸ªå­—èŠ‚ç»„æˆï¼Œå‰ä¸¤ä¸ªå­—èŠ‚æŒ‡ç¤ºpythonç‰ˆæœ¬å·ï¼Œå¯ä»¥é€šè¿‡æŸ¥çœ‹pythonæºç <a href="https://github.com/python/cpython/tree/2.7">https://github.com/python/cpython/tree/2.7</a> ä¸­Pythonæ–‡ä»¶å¤¹é‡Œçš„<code>import.c</code>æ–‡ä»¶ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">Known values:</span><br><span class="line">    Python 1.5:   20121</span><br><span class="line">    Python 1.5.1: 20121</span><br><span class="line">    Python 1.5.2: 20121</span><br><span class="line">    Python 1.6:   50428</span><br><span class="line">    Python 2.0:   50823</span><br><span class="line">    Python 2.0.1: 50823</span><br><span class="line">    Python 2.1:   60202</span><br><span class="line">    Python 2.1.1: 60202</span><br><span class="line">    Python 2.1.2: 60202</span><br><span class="line">    Python 2.2:   60717</span><br><span class="line">    Python 2.3a0: 62011</span><br><span class="line">    Python 2.3a0: 62021</span><br><span class="line">    Python 2.3a0: 62011 (!)</span><br><span class="line">    Python 2.4a0: 62041</span><br><span class="line">    Python 2.4a3: 62051</span><br><span class="line">    Python 2.4b1: 62061</span><br><span class="line">    Python 2.5a0: 62071</span><br><span class="line">    Python 2.5a0: 62081 (ast-branch)</span><br><span class="line">    Python 2.5a0: 62091 (with)</span><br><span class="line">    Python 2.5a0: 62092 (changed WITH_CLEANUP opcode)</span><br><span class="line">    Python 2.5b3: 62101 (fix wrong code: for x, in ...)</span><br><span class="line">    Python 2.5b3: 62111 (fix wrong code: x += yield)</span><br><span class="line">    Python 2.5c1: 62121 (fix wrong lnotab with for loops and</span><br><span class="line">                         storing constants that should have been removed)</span><br><span class="line">    Python 2.5c2: 62131 (fix wrong code: for x, in ... in listcomp/genexp)</span><br><span class="line">    Python 2.6a0: 62151 (peephole optimizations and STORE_MAP opcode)</span><br><span class="line">    Python 2.6a1: 62161 (WITH_CLEANUP optimization)</span><br><span class="line">    Python 2.7a0: 62171 (optimize list comprehensions/change LIST_APPEND)</span><br><span class="line">    Python 2.7a0: 62181 (optimize conditional branches:</span><br><span class="line">             introduce POP_JUMP_IF_FALSE and POP_JUMP_IF_TRUE)</span><br><span class="line">    Python 2.7a0  62191 (introduce SETUP_WITH)</span><br><span class="line">    Python 2.7a0  62201 (introduce BUILD_SET)</span><br><span class="line">    Python 2.7a0  62211 (introduce MAP_ADD and SET_ADD)</span><br></pre></td></tr></table></figure>

<p>è¿™ä¸ªpycæ–‡ä»¶å‰ä¸¤ä½æ˜¯03 F3å°ç«¯æ’åˆ—ï¼Œç›¸å½“äºåè¿›åˆ¶çš„62211ï¼Œæ‰€ä»¥è¿™ä¸ªpycæ–‡ä»¶éœ€è¦python2.7çš„è§£é‡Šå™¨æ‰§è¡Œã€‚</p>
<p>ä½¿ç”¨python2.7ç”¨åŒæ ·çš„å‘½ä»¤æ‰“å¼€ï¼Œåœ¨ç¬¬23è¡Œ<code>dis.disassemble(code)</code>ä¼šæŠ¥é”™ï¼Œå› ä¸ºè¿™ä¸ªpycæ”¹äº†å¾ˆå¤šopcodeï¼Œæœ‰äº›æ— æ³•æ‰¾åˆ°å¯¹åº”çš„opcodeï¼Œå› æ­¤æ³¨é‡Šè¿™ä¸€è¡Œåç»§ç»­æ‰§è¡Œï¼Œå¾—åˆ°ä¸‹é¢çš„ç»“æœã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line">magic 03f30d0a</span><br><span class="line">moddate 66346f58 (Fri Jan  6 01:08:38 2017)</span><br><span class="line">code</span><br><span class="line">   argcount 0</span><br><span class="line">   nlocals 0</span><br><span class="line">   stacksize 2</span><br><span class="line">   flags 0040</span><br><span class="line">code length: 34</span><br><span class="line">   code</span><br><span class="line">      990000990100860000910000990200880000910100990300880000910200</span><br><span class="line">      99010053</span><br><span class="line">   consts</span><br><span class="line">      -1</span><br><span class="line">      None</span><br><span class="line">      code</span><br><span class="line">         argcount 1</span><br><span class="line">         nlocals 6</span><br><span class="line">         stacksize 3</span><br><span class="line">         flags 0043</span><br><span class="line">code length: 92</span><br><span class="line">         code</span><br><span class="line">            990100680100990200680200990300680300610100990400469905002761</span><br><span class="line">            020061010027610300279906004627990500276102009906004627990700</span><br><span class="line">            276804009b00006001006104008301006805006105006002006100008301</span><br><span class="line">            0053</span><br><span class="line">         consts</span><br><span class="line">            None</span><br><span class="line">            &#x27;!@#$%^&amp;*&#x27;</span><br><span class="line">            &#x27;abcdefgh&#x27;</span><br><span class="line">            &#x27;&lt;&gt;&#123;&#125;:&quot;&#x27;</span><br><span class="line">            4</span><br><span class="line">            &#x27;|&#x27;</span><br><span class="line">            2</span><br><span class="line">            &#x27;EOF&#x27;</span><br><span class="line">         names (&#x27;rotor&#x27;, &#x27;newrotor&#x27;, &#x27;encrypt&#x27;)</span><br><span class="line">         varnames (&#x27;data&#x27;, &#x27;key_a&#x27;, &#x27;key_b&#x27;, &#x27;key_c&#x27;, &#x27;secret&#x27;, &#x27;rot&#x27;)</span><br><span class="line">         freevars ()</span><br><span class="line">         cellvars ()</span><br><span class="line">         filename &#x27;/Users/hen/Lab/0CTF/py/crypt.py&#x27;</span><br><span class="line">         name &#x27;encrypt&#x27;</span><br><span class="line">         firstlineno 2</span><br><span class="line">         lnotab 00010601060106012e010f01</span><br><span class="line">      code</span><br><span class="line">         argcount 1</span><br><span class="line">         nlocals 6</span><br><span class="line">         stacksize 3</span><br><span class="line">         flags 0043</span><br><span class="line">code length: 92</span><br><span class="line">         code</span><br><span class="line">            990100680100990200680200990300680300610100990400469905002761</span><br><span class="line">            020061010027610300279906004627990500276102009906004627990700</span><br><span class="line">            276804009b00006001006104008301006805006105006002006100008301</span><br><span class="line">            0053</span><br><span class="line">         consts</span><br><span class="line">            None</span><br><span class="line">            &#x27;!@#$%^&amp;*&#x27;</span><br><span class="line">            &#x27;abcdefgh&#x27;</span><br><span class="line">            &#x27;&lt;&gt;&#123;&#125;:&quot;&#x27;</span><br><span class="line">            4</span><br><span class="line">            &#x27;|&#x27;</span><br><span class="line">            2</span><br><span class="line">            &#x27;EOF&#x27;</span><br><span class="line">         names (&#x27;rotor&#x27;, &#x27;newrotor&#x27;, &#x27;decrypt&#x27;)</span><br><span class="line">         varnames (&#x27;data&#x27;, &#x27;key_a&#x27;, &#x27;key_b&#x27;, &#x27;key_c&#x27;, &#x27;secret&#x27;, &#x27;rot&#x27;)</span><br><span class="line">         freevars ()</span><br><span class="line">         cellvars ()</span><br><span class="line">         filename &#x27;/Users/hen/Lab/0CTF/py/crypt.py&#x27;</span><br><span class="line">         name &#x27;decrypt&#x27;</span><br><span class="line">         firstlineno 10</span><br><span class="line">         lnotab 00010601060106012e010f01</span><br><span class="line">   names (&#x27;rotor&#x27;, &#x27;encrypt&#x27;, &#x27;decrypt&#x27;)</span><br><span class="line">   varnames ()</span><br><span class="line">   freevars ()</span><br><span class="line">   cellvars ()</span><br><span class="line">   filename &#x27;/Users/hen/Lab/0CTF/py/crypt.py&#x27;</span><br><span class="line">   name &#x27;&lt;module&gt;&#x27;</span><br><span class="line">   firstlineno 1</span><br><span class="line">   lnotab 0c010908</span><br></pre></td></tr></table></figure>

<p>constæ˜¯pythonä»£ç ä¸­çš„é™æ€å˜é‡ï¼Œvarnamesæ˜¯æ™®é€šå˜é‡ï¼Œnamesæ˜¯å¤–éƒ¨å˜é‡ã€‚æ¯”å¦‚<code>a = str(1) + &#39;2&#39;</code>ï¼Œå…¶ä¸­aå­˜åœ¨varnamesï¼Œstrå­˜åœ¨namesï¼Œ1å’Œâ€™2â€™å­˜åœ¨constä¸­ã€‚</p>
<p>å¯ä»¥çœ‹åˆ°ä¸Šé¢çš„pycä¸­ä½¿ç”¨äº†rotorè¿™ä¸ªå¤–éƒ¨å˜é‡ï¼Œæœç´¢åå‘ç°è¿™æ˜¯ä¸€ä¸ªåŠ å¯†çš„åº“ï¼ˆ<a href="http://www.bugingcode.com/blog/python_rotor.html">http://www.bugingcode.com/blog/python_rotor.html</a> ï¼‰ï¼Œå¤§æ¦‚ç”¨æ³•å¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> rotor</span><br><span class="line">key = <span class="string">&#x27;12345&#x27;</span></span><br><span class="line">rot = rotor.newrotor(key)</span><br><span class="line">rot.encrypt(balabala);</span><br><span class="line">rot.decrypt(balabala);</span><br></pre></td></tr></table></figure>

<p>çœ‹åˆ°pycé‡Œæœ‰key_aã€key_bã€key_cã€secret4ä¸ªå˜é‡ï¼Œå¤§æ¦‚ä¼šæ˜¯æœ‰abcæ¥ç”Ÿæˆsecretã€‚å› ä¸ºpycæ–‡ä»¶é‡Œopcodeä¼šè¯†åˆ«ä¸äº†ï¼Œæ‰€ä»¥æˆ‘æƒ³è¦ä¸æ”¹æ”¹dis.disassembleè¿™ä¸ªå‡½æ•°ï¼Œè®©èƒ½è¯†åˆ«å…ˆè¯†åˆ«ï¼Œä¸èƒ½çš„å°±ç•™opcodeçš„å€¼ã€‚ä¸‹é¢å°±æ˜¯æ”¹äº†disassembleã€‚</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> op &gt;= HAVE_ARGUMENT:</span><br><span class="line">            oparg = <span class="built_in">ord</span>(code[i]) + <span class="built_in">ord</span>(code[i+<span class="number">1</span>])*<span class="number">256</span> + extended_arg</span><br><span class="line">            extended_arg = <span class="number">0</span></span><br><span class="line">            i = i+<span class="number">2</span></span><br><span class="line">            <span class="keyword">if</span> op == EXTENDED_ARG:</span><br><span class="line">                extended_arg = oparg*<span class="number">65536L</span></span><br><span class="line">            <span class="built_in">print</span> <span class="built_in">repr</span>(oparg).rjust(<span class="number">5</span>),</span><br><span class="line">            <span class="keyword">if</span> op <span class="keyword">in</span> hasconst:</span><br><span class="line">                <span class="keyword">if</span> oparg &gt;= <span class="built_in">len</span>(co.co_consts):</span><br><span class="line">                    <span class="built_in">print</span> <span class="string">&#x27;(const 0x&#x27;</span> + <span class="built_in">hex</span>(oparg) + <span class="string">&#x27;)&#x27;</span>,  <span class="comment"># æ·»åŠ åˆ¤æ–­</span></span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    <span class="built_in">print</span> <span class="string">&#x27;(&#x27;</span> + <span class="built_in">repr</span>(co.co_consts[oparg]) + <span class="string">&#x27;)&#x27;</span>,</span><br><span class="line">            <span class="keyword">elif</span> op <span class="keyword">in</span> hasname:</span><br><span class="line">                <span class="keyword">if</span> oparg &gt;= <span class="built_in">len</span>(co.co_names):</span><br><span class="line">                    <span class="built_in">print</span> <span class="string">&#x27;(names 0x&#x27;</span> + <span class="built_in">hex</span>(oparg) + <span class="string">&#x27;)&#x27;</span>,  <span class="comment"># æ·»åŠ åˆ¤æ–­</span></span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    <span class="built_in">print</span> <span class="string">&#x27;(&#x27;</span> + co.co_names[oparg] + <span class="string">&#x27;)&#x27;</span>,</span><br><span class="line">            <span class="keyword">elif</span> op <span class="keyword">in</span> hasjrel:</span><br><span class="line">                <span class="built_in">print</span> <span class="string">&#x27;(to &#x27;</span> + <span class="built_in">repr</span>(i + oparg) + <span class="string">&#x27;)&#x27;</span>,</span><br><span class="line">            <span class="keyword">elif</span> op <span class="keyword">in</span> haslocal:</span><br><span class="line">                <span class="built_in">print</span> <span class="string">&#x27;(&#x27;</span> + co.co_varnames[oparg] + <span class="string">&#x27;)&#x27;</span>,</span><br><span class="line">            <span class="keyword">elif</span> op <span class="keyword">in</span> hascompare:</span><br><span class="line">                <span class="built_in">print</span> <span class="string">&#x27;(&#x27;</span> + cmp_op[oparg] + <span class="string">&#x27;)&#x27;</span>,</span><br><span class="line">            <span class="keyword">elif</span> op <span class="keyword">in</span> hasfree:</span><br><span class="line">                <span class="keyword">if</span> free <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">                    free = co.co_cellvars + co.co_freevars</span><br><span class="line">                <span class="keyword">if</span> oparg &gt;= <span class="built_in">len</span>(free):</span><br><span class="line">                    <span class="built_in">print</span> <span class="string">&#x27;(free 0x&#x27;</span> + <span class="built_in">hex</span>(oparg) + <span class="string">&#x27;)&#x27;</span>,  <span class="comment"># æ·»åŠ åˆ¤æ–­</span></span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    <span class="built_in">print</span> <span class="string">&#x27;(&#x27;</span> + free[oparg] + <span class="string">&#x27;)&#x27;</span>,</span><br><span class="line">        <span class="built_in">print</span></span><br></pre></td></tr></table></figure>

<p>ç„¶åå†æ¬¡è¿è¡Œ<code>python3 disassem.py crypt.pyc</code>ï¼Œä½†æ˜¯å¾—åˆ°çš„ç»“æœå¾ˆè¿·ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br></pre></td><td class="code"><pre><span class="line">magic 03f30d0a</span><br><span class="line">moddate 66346f58 (Fri Jan  <span class="number">6</span> 01:08:<span class="number">38</span> <span class="number">2017</span>)</span><br><span class="line">code</span><br><span class="line">   argcount <span class="number">0</span></span><br><span class="line">   nlocals <span class="number">0</span></span><br><span class="line">   stacksize <span class="number">2</span></span><br><span class="line">   flags 0040</span><br><span class="line">code length: <span class="number">34</span></span><br><span class="line">   code</span><br><span class="line">      <span class="number">990000990100860000910000990200880000910100990300880000910200</span></span><br><span class="line">      <span class="number">99010053</span></span><br><span class="line">  <span class="number">1</span>           <span class="number">0</span> &lt;<span class="number">153</span>&gt;                    <span class="number">0</span></span><br><span class="line">              <span class="number">3</span> &lt;<span class="number">153</span>&gt;                    <span class="number">1</span></span><br><span class="line">              <span class="number">6</span> MAKE_CLOSURE             <span class="number">0</span></span><br><span class="line">              <span class="number">9</span> EXTENDED_ARG             <span class="number">0</span></span><br><span class="line"></span><br><span class="line">  <span class="number">2</span>          <span class="number">12</span> &lt;<span class="number">153</span>&gt;                   <span class="number">2L</span></span><br><span class="line">             <span class="number">15</span> LOAD_DEREF               <span class="number">0</span> (free 0x0x0)</span><br><span class="line">             <span class="number">18</span> EXTENDED_ARG             <span class="number">1</span></span><br><span class="line"></span><br><span class="line"> <span class="number">10</span>          <span class="number">21</span> &lt;<span class="number">153</span>&gt;                <span class="number">65539L</span></span><br><span class="line">             <span class="number">24</span> LOAD_DEREF               <span class="number">0</span> (free 0x0x0)</span><br><span class="line">             <span class="number">27</span> EXTENDED_ARG             <span class="number">2</span></span><br><span class="line">             <span class="number">30</span> &lt;<span class="number">153</span>&gt;                <span class="number">131073L</span></span><br><span class="line">             <span class="number">33</span> RETURN_VALUE        </span><br><span class="line">   consts</span><br><span class="line">      -<span class="number">1</span></span><br><span class="line">      <span class="literal">None</span></span><br><span class="line">      code</span><br><span class="line">         argcount <span class="number">1</span></span><br><span class="line">         nlocals <span class="number">6</span></span><br><span class="line">         stacksize <span class="number">3</span></span><br><span class="line">         flags 0043</span><br><span class="line">code length: <span class="number">92</span></span><br><span class="line">         code</span><br><span class="line">            <span class="number">990100680100990200680200990300680300610100990400469905002761</span></span><br><span class="line">            020061010027610300279906004627990500276102009906004627990700</span><br><span class="line">            276804009b00006001006104008301006805006105006002006100008301</span><br><span class="line">            0053</span><br><span class="line">  <span class="number">3</span>           <span class="number">0</span> &lt;<span class="number">153</span>&gt;                    <span class="number">1</span></span><br><span class="line">              <span class="number">3</span> BUILD_SET                <span class="number">1</span></span><br><span class="line"></span><br><span class="line">  <span class="number">4</span>           <span class="number">6</span> &lt;<span class="number">153</span>&gt;                    <span class="number">2</span></span><br><span class="line">              <span class="number">9</span> BUILD_SET                <span class="number">2</span></span><br><span class="line"></span><br><span class="line">  <span class="number">5</span>          <span class="number">12</span> &lt;<span class="number">153</span>&gt;                    <span class="number">3</span></span><br><span class="line">             <span class="number">15</span> BUILD_SET                <span class="number">3</span></span><br><span class="line"></span><br><span class="line">  <span class="number">6</span>          <span class="number">18</span> STORE_GLOBAL             <span class="number">1</span> (newrotor)</span><br><span class="line">             <span class="number">21</span> &lt;<span class="number">153</span>&gt;                    <span class="number">4</span></span><br><span class="line">             <span class="number">24</span> PRINT_EXPR          </span><br><span class="line">             <span class="number">25</span> &lt;<span class="number">153</span>&gt;                    <span class="number">5</span></span><br><span class="line">             <span class="number">28</span> &lt;<span class="number">39</span>&gt;                </span><br><span class="line">             <span class="number">29</span> STORE_GLOBAL             <span class="number">2</span> (encrypt)</span><br><span class="line">             <span class="number">32</span> STORE_GLOBAL             <span class="number">1</span> (newrotor)</span><br><span class="line">             <span class="number">35</span> &lt;<span class="number">39</span>&gt;                </span><br><span class="line">             <span class="number">36</span> STORE_GLOBAL             <span class="number">3</span> (names 0x0x3)</span><br><span class="line">             <span class="number">39</span> &lt;<span class="number">39</span>&gt;                </span><br><span class="line">             <span class="number">40</span> &lt;<span class="number">153</span>&gt;                    <span class="number">6</span></span><br><span class="line">             <span class="number">43</span> PRINT_EXPR          </span><br><span class="line">             <span class="number">44</span> &lt;<span class="number">39</span>&gt;                </span><br><span class="line">             <span class="number">45</span> &lt;<span class="number">153</span>&gt;                    <span class="number">5</span></span><br><span class="line">             <span class="number">48</span> &lt;<span class="number">39</span>&gt;                </span><br><span class="line">             <span class="number">49</span> STORE_GLOBAL             <span class="number">2</span> (encrypt)</span><br><span class="line">             <span class="number">52</span> &lt;<span class="number">153</span>&gt;                    <span class="number">6</span></span><br><span class="line">             <span class="number">55</span> PRINT_EXPR          </span><br><span class="line">             <span class="number">56</span> &lt;<span class="number">39</span>&gt;                </span><br><span class="line">             <span class="number">57</span> &lt;<span class="number">153</span>&gt;                    <span class="number">7</span></span><br><span class="line">             <span class="number">60</span> &lt;<span class="number">39</span>&gt;                </span><br><span class="line">             <span class="number">61</span> BUILD_SET                <span class="number">4</span></span><br><span class="line"></span><br><span class="line">  <span class="number">7</span>          <span class="number">64</span> &lt;<span class="number">155</span>&gt;                    <span class="number">0</span></span><br><span class="line">             <span class="number">67</span> DELETE_ATTR              <span class="number">1</span> (newrotor)</span><br><span class="line">             <span class="number">70</span> STORE_GLOBAL             <span class="number">4</span> (names 0x0x4)</span><br><span class="line">             <span class="number">73</span> CALL_FUNCTION            <span class="number">1</span></span><br><span class="line">             <span class="number">76</span> BUILD_SET                <span class="number">5</span></span><br><span class="line"></span><br><span class="line">  <span class="number">8</span>          <span class="number">79</span> STORE_GLOBAL             <span class="number">5</span> (names 0x0x5)</span><br><span class="line">             <span class="number">82</span> DELETE_ATTR              <span class="number">2</span> (encrypt)</span><br><span class="line">             <span class="number">85</span> STORE_GLOBAL             <span class="number">0</span> (rotor)</span><br><span class="line">             <span class="number">88</span> CALL_FUNCTION            <span class="number">1</span></span><br><span class="line">             <span class="number">91</span> RETURN_VALUE        </span><br><span class="line">         consts</span><br><span class="line">            <span class="literal">None</span></span><br><span class="line">            <span class="string">&#x27;!@#$%^&amp;*&#x27;</span></span><br><span class="line">            <span class="string">&#x27;abcdefgh&#x27;</span></span><br><span class="line">            <span class="string">&#x27;&lt;&gt;&#123;&#125;:&quot;&#x27;</span></span><br><span class="line">            <span class="number">4</span></span><br><span class="line">            <span class="string">&#x27;|&#x27;</span></span><br><span class="line">            <span class="number">2</span></span><br><span class="line">            <span class="string">&#x27;EOF&#x27;</span></span><br><span class="line">         names (<span class="string">&#x27;rotor&#x27;</span>, <span class="string">&#x27;newrotor&#x27;</span>, <span class="string">&#x27;encrypt&#x27;</span>)</span><br><span class="line">         varnames (<span class="string">&#x27;data&#x27;</span>, <span class="string">&#x27;key_a&#x27;</span>, <span class="string">&#x27;key_b&#x27;</span>, <span class="string">&#x27;key_c&#x27;</span>, <span class="string">&#x27;secret&#x27;</span>, <span class="string">&#x27;rot&#x27;</span>)</span><br><span class="line">         freevars ()</span><br><span class="line">         cellvars ()</span><br><span class="line">         filename <span class="string">&#x27;/Users/hen/Lab/0CTF/py/crypt.py&#x27;</span></span><br><span class="line">         name <span class="string">&#x27;encrypt&#x27;</span></span><br><span class="line">         firstlineno <span class="number">2</span></span><br><span class="line">         lnotab <span class="number">00010601060106012e0</span>10f01</span><br><span class="line">      code</span><br><span class="line">         argcount <span class="number">1</span></span><br><span class="line">         nlocals <span class="number">6</span></span><br><span class="line">         stacksize <span class="number">3</span></span><br><span class="line">         flags 0043</span><br><span class="line">code length: <span class="number">92</span></span><br><span class="line">         code</span><br><span class="line">            <span class="number">990100680100990200680200990300680300610100990400469905002761</span></span><br><span class="line">            020061010027610300279906004627990500276102009906004627990700</span><br><span class="line">            276804009b00006001006104008301006805006105006002006100008301</span><br><span class="line">            0053</span><br><span class="line"> <span class="number">11</span>           <span class="number">0</span> &lt;<span class="number">153</span>&gt;                    <span class="number">1</span></span><br><span class="line">              <span class="number">3</span> BUILD_SET                <span class="number">1</span></span><br><span class="line"></span><br><span class="line"> <span class="number">12</span>           <span class="number">6</span> &lt;<span class="number">153</span>&gt;                    <span class="number">2</span></span><br><span class="line">              <span class="number">9</span> BUILD_SET                <span class="number">2</span></span><br><span class="line"></span><br><span class="line"> <span class="number">13</span>          <span class="number">12</span> &lt;<span class="number">153</span>&gt;                    <span class="number">3</span></span><br><span class="line">             <span class="number">15</span> BUILD_SET                <span class="number">3</span></span><br><span class="line"></span><br><span class="line"> <span class="number">14</span>          <span class="number">18</span> STORE_GLOBAL             <span class="number">1</span> (newrotor)</span><br><span class="line">             <span class="number">21</span> &lt;<span class="number">153</span>&gt;                    <span class="number">4</span></span><br><span class="line">             <span class="number">24</span> PRINT_EXPR          </span><br><span class="line">             <span class="number">25</span> &lt;<span class="number">153</span>&gt;                    <span class="number">5</span></span><br><span class="line">             <span class="number">28</span> &lt;<span class="number">39</span>&gt;                </span><br><span class="line">             <span class="number">29</span> STORE_GLOBAL             <span class="number">2</span> (decrypt)</span><br><span class="line">             <span class="number">32</span> STORE_GLOBAL             <span class="number">1</span> (newrotor)</span><br><span class="line">             <span class="number">35</span> &lt;<span class="number">39</span>&gt;                </span><br><span class="line">             <span class="number">36</span> STORE_GLOBAL             <span class="number">3</span> (names 0x0x3)</span><br><span class="line">             <span class="number">39</span> &lt;<span class="number">39</span>&gt;                </span><br><span class="line">             <span class="number">40</span> &lt;<span class="number">153</span>&gt;                    <span class="number">6</span></span><br><span class="line">             <span class="number">43</span> PRINT_EXPR          </span><br><span class="line">             <span class="number">44</span> &lt;<span class="number">39</span>&gt;                </span><br><span class="line">             <span class="number">45</span> &lt;<span class="number">153</span>&gt;                    <span class="number">5</span></span><br><span class="line">             <span class="number">48</span> &lt;<span class="number">39</span>&gt;                </span><br><span class="line">             <span class="number">49</span> STORE_GLOBAL             <span class="number">2</span> (decrypt)</span><br><span class="line">             <span class="number">52</span> &lt;<span class="number">153</span>&gt;                    <span class="number">6</span></span><br><span class="line">             <span class="number">55</span> PRINT_EXPR          </span><br><span class="line">             <span class="number">56</span> &lt;<span class="number">39</span>&gt;                </span><br><span class="line">             <span class="number">57</span> &lt;<span class="number">153</span>&gt;                    <span class="number">7</span></span><br><span class="line">             <span class="number">60</span> &lt;<span class="number">39</span>&gt;                </span><br><span class="line">             <span class="number">61</span> BUILD_SET                <span class="number">4</span></span><br><span class="line"></span><br><span class="line"> <span class="number">15</span>          <span class="number">64</span> &lt;<span class="number">155</span>&gt;                    <span class="number">0</span></span><br><span class="line">             <span class="number">67</span> DELETE_ATTR              <span class="number">1</span> (newrotor)</span><br><span class="line">             <span class="number">70</span> STORE_GLOBAL             <span class="number">4</span> (names 0x0x4)</span><br><span class="line">             <span class="number">73</span> CALL_FUNCTION            <span class="number">1</span></span><br><span class="line">             <span class="number">76</span> BUILD_SET                <span class="number">5</span></span><br><span class="line"></span><br><span class="line"> <span class="number">16</span>          <span class="number">79</span> STORE_GLOBAL             <span class="number">5</span> (names 0x0x5)</span><br><span class="line">             <span class="number">82</span> DELETE_ATTR              <span class="number">2</span> (decrypt)</span><br><span class="line">             <span class="number">85</span> STORE_GLOBAL             <span class="number">0</span> (rotor)</span><br><span class="line">             <span class="number">88</span> CALL_FUNCTION            <span class="number">1</span></span><br><span class="line">             <span class="number">91</span> RETURN_VALUE        </span><br><span class="line">         consts</span><br><span class="line">            <span class="literal">None</span></span><br><span class="line">            <span class="string">&#x27;!@#$%^&amp;*&#x27;</span></span><br><span class="line">            <span class="string">&#x27;abcdefgh&#x27;</span></span><br><span class="line">            <span class="string">&#x27;&lt;&gt;&#123;&#125;:&quot;&#x27;</span></span><br><span class="line">            <span class="number">4</span></span><br><span class="line">            <span class="string">&#x27;|&#x27;</span></span><br><span class="line">            <span class="number">2</span></span><br><span class="line">            <span class="string">&#x27;EOF&#x27;</span></span><br><span class="line">         names (<span class="string">&#x27;rotor&#x27;</span>, <span class="string">&#x27;newrotor&#x27;</span>, <span class="string">&#x27;decrypt&#x27;</span>)</span><br><span class="line">         varnames (<span class="string">&#x27;data&#x27;</span>, <span class="string">&#x27;key_a&#x27;</span>, <span class="string">&#x27;key_b&#x27;</span>, <span class="string">&#x27;key_c&#x27;</span>, <span class="string">&#x27;secret&#x27;</span>, <span class="string">&#x27;rot&#x27;</span>)</span><br><span class="line">         freevars ()</span><br><span class="line">         cellvars ()</span><br><span class="line">         filename <span class="string">&#x27;/Users/hen/Lab/0CTF/py/crypt.py&#x27;</span></span><br><span class="line">         name <span class="string">&#x27;decrypt&#x27;</span></span><br><span class="line">         firstlineno <span class="number">10</span></span><br><span class="line">         lnotab <span class="number">00010601060106012e0</span>10f01</span><br><span class="line">   names (<span class="string">&#x27;rotor&#x27;</span>, <span class="string">&#x27;encrypt&#x27;</span>, <span class="string">&#x27;decrypt&#x27;</span>)</span><br><span class="line">   varnames ()</span><br><span class="line">   freevars ()</span><br><span class="line">   cellvars ()</span><br><span class="line">   filename <span class="string">&#x27;/Users/hen/Lab/0CTF/py/crypt.py&#x27;</span></span><br><span class="line">   name <span class="string">&#x27;&lt;module&gt;&#x27;</span></span><br><span class="line">   firstlineno <span class="number">1</span></span><br><span class="line">   lnotab 0c010908</span><br></pre></td></tr></table></figure>

<p>ç»“æœå¾ˆè¿·ï¼Œç‰¹åˆ«æ˜¯150è¡Œã€151è¡Œï¼Œåº”è¯¥æ˜¯load attrã€load nameç„¶åcall functionæ‰å¯¹ã€‚ç„¶åæˆ‘æƒ³ç€è¦ä¸è§£ææ‰‹å·¥è¯•è¯•ï¼ŒpythonæŒ‡ä»¤æ ¼å¼å¦‚: opcode + å‚æ•°ä½ç½® + 0x00ç»„åˆï¼Œæ¯”å¦‚load_const 1 è¡¨ç¤ºåŠ è½½ç¬¬1ä¸ªï¼ˆä»0å¼€å§‹ï¼‰çš„constå˜é‡ï¼Œload_constçš„opcodeæ˜¯0x64ï¼Œæ‰€ä»¥load_const 1è¡¨ç¤º0x64 0x01 0x00ã€‚opcodeå¯¹åº”æ•°å­—å¯ä»¥åœ¨<a href="https://github.com/python/cpython/blob/2.7/Include/opcode.h">https://github.com/python/cpython/blob/2.7/Include/opcode.h</a> æŸ¥çœ‹ï¼Œå…¶ä»–çš„æ¯”å¦‚return åªæœ‰ä¸€ä¸ªå­—èŠ‚0x53è¡¨ç¤ºï¼Œç„¶åæˆ‘æŒ‰ç…§è¿™ä¸ªè§„å¾‹åˆ†æcodeã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">990100  LOAD CONST  &#x27;!@#$%^&amp;*&#x27;</span><br><span class="line">680100  store varname keya</span><br><span class="line">990200  LOAD CONST  &#x27;abcdefgh&#x27;</span><br><span class="line">680200  store varname keyb</span><br><span class="line">990300  LOAD CONST  &#x27;&lt;&gt;&#123;&#125;:&quot;&#x27;</span><br><span class="line">680300  store varname keyc</span><br><span class="line">610100  load varname keya</span><br><span class="line">990400  LOAD CONST 4</span><br><span class="line">46      æŸä¸ªæ“ä½œéœ€è¦å‚æ•°key_aä¸4</span><br><span class="line">990500  LOAD CONST &#x27;|&#x27;</span><br><span class="line">27</span><br><span class="line">610200  load varname keyb</span><br><span class="line">610100  load varname keya</span><br><span class="line">27      </span><br><span class="line">610300  load varname keyc</span><br><span class="line">27</span><br><span class="line">990600  LOAD CONST 2</span><br><span class="line">46      æŸä¸ªä¸2</span><br><span class="line">27</span><br><span class="line">990500  LOAD CONST &#x27;|&#x27; </span><br><span class="line">27</span><br><span class="line">610200  load varname keyb</span><br><span class="line">990600  LOAD CONST 2</span><br><span class="line">46      keybä¸2çš„æ“ä½œ</span><br><span class="line">27      éš¾é“æ˜¯+å·ï¼Ÿ</span><br><span class="line">990700  LOAD CONST &#x27;EOF&#x27;</span><br><span class="line">27</span><br><span class="line">680400  store varname secret</span><br><span class="line">9b0000</span><br><span class="line">600100  load attr newrotor</span><br><span class="line">610400  load varname secret</span><br><span class="line">830100  call function newrotor</span><br><span class="line">680500  store varname rot</span><br><span class="line">610500  load varname rot</span><br><span class="line">600200  load attr encrypt</span><br><span class="line">610000  load varname data</span><br><span class="line">830100  call function encrypt</span><br><span class="line">53      return</span><br></pre></td></tr></table></figure>

<p>ä½†æ˜¯å¦‚æœæŒ‰ç…§opcodeæ¥ç¿»è¯‘ä¸Šé¢çš„ä»£ç ä¼šå‡ºç°é—®é¢˜ï¼Œæ¯”å¦‚610000åº”è¯¥store_globalã€990700ç­‰ç­‰ä¸å¯¹åº”çš„æƒ…å†µï¼Œæ‰€ä»¥æˆ‘çœ‹äº†çœ‹å¤§ä½¬æ€ä¹ˆå†™çš„ï¼Œå‘ç°ä»–æ˜¯è‡ªå·±å†™ä¸€ä¸ªrotorçš„è„šæœ¬ï¼Œå†åç¼–è¯‘åä¸crypt.pycä½œå¯¹æ¯”ï¼Œæˆ‘æŒ‰ç…§ä»–çš„æ€è·¯å°†å­—èŠ‚ç ç¿»è¯‘ï¼Œç‰¹åˆ«çš„99åº”è¯¥æ˜¯constå› ä¸ºç¬¬26è¡Œ99070å–å‡ºç¬¬8ä¸ªå˜é‡ï¼Œè€Œåªæœ‰consté™æ€å˜é‡é‡Œé¢æœ‰8ä¸ªå…ƒç´ ï¼Œæ•…99è¡¨ç¤ºload constã€‚ä½†æ˜¯é‡Œé¢çš„0x46ã€0x27å¹¶ä¸çŸ¥é“æ˜¯æ€ä¹ˆæ“ä½œï¼Œæ¯”å¦‚ç¬¬9è¡Œå‰ï¼Œload varname keyaï¼Œload const 4, ç›¸å½“äºop1(keya, 4)ï¼Œpythoné‡Œé¢ä½¿ç”¨æ ˆæ¥ä¼ å‚æ•°ï¼Œå‚æ•°é¡ºåºæŒ‰ç…§æ ˆåº•åˆ°æ ˆé¡¶çš„é¡ºåºã€‚å› æ­¤è§‚å¯Ÿ0x46å’Œ0x27çš„éƒ¨åˆ†ä»£ç ï¼Œå°†å…¶å˜ä¸ºä¼ªä»£ç ï¼Œå…¶ä¸­op1è¡¨ç¤º0x46ã€op2è¡¨ç¤º0x27:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">secret = op2(op1(op1(op2(op1(keya, 4), &#x27;|&#x27;), op1(op2(op2(keyb, keya), keyc), 2)), &#x27;|&#x27;), op2(keyb, 2))</span><br></pre></td></tr></table></figure>

<p>å…¶ä¸­keyaæ˜¯å­—ç¬¦ä¸²ï¼Œè€Œ4æ˜¯æ•´æ•°ï¼Œé‚£ä¹ˆ<code>op1(keya, 4)</code>çš„æ“ä½œåº”è¯¥æ˜¯<code>*</code>ï¼Œè¿”å›å­—ç¬¦ä¸²ï¼Œè€Œ<code>op2(op1(keya, 4), &#39;|&#39;)</code>æ˜¯ä¸¤ä¸ªå­—ç¬¦ä¸²çš„æ“ä½œï¼Œåº”è¯¥æ˜¯<code>+</code>ï¼Œæ•…secretå¯ä»¥é€šè¿‡ä¸‹é¢çš„ä»£ç å¾—åˆ°:</p>
<p><code>secret = key_a * 4 + &#39;|&#39; + (key_b + key_a + key_c)*2 + &#39;|&#39; + key_b*2 + &#39;EOF&#39;</code></p>
<p>ç„¶åå°†è¿™ä¸²ä»£ç å†™æˆè„šæœ¬æ¥å®ç°å¯¹encrypt_flagçš„è§£å¯†</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> rotor</span><br><span class="line">key_a = <span class="string">&#x27;!@#$%^&amp;*&#x27;</span></span><br><span class="line">key_b = <span class="string">&#x27;abcdefgh&#x27;</span></span><br><span class="line">key_c = <span class="string">&#x27;&lt;&gt;&#123;&#125;:&quot;&#x27;</span></span><br><span class="line">secret = key_a * <span class="number">4</span> + <span class="string">&#x27;|&#x27;</span> + (key_b + key_a + key_c)*<span class="number">2</span> + <span class="string">&#x27;|&#x27;</span> + key_b*<span class="number">2</span> + <span class="string">&#x27;EOF&#x27;</span></span><br><span class="line"></span><br><span class="line">rot = rotor.newrotor(secret)</span><br><span class="line"><span class="built_in">print</span>(rot.decrypt(<span class="built_in">open</span>(<span class="string">&#x27;encrypted_flag&#x27;</span>, <span class="string">&#x27;rb&#x27;</span>).read()))</span><br></pre></td></tr></table></figure>

<p>æœ€åå¾—åˆ°ç­”æ¡ˆï¼šflag{Gue55_opcode_G@@@me}</p>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p>pythonå­—èŠ‚ç  <a href="http://www.bravegnu.org/blog/python-byte-code-hacks.html">http://www.bravegnu.org/blog/python-byte-code-hacks.html</a><br>opcodeå‚è€ƒ <a href="http://unpyc.sourceforge.net/Opcodes.html">http://unpyc.sourceforge.net/Opcodes.html</a></p>
</div><div><ul class="post-copyright"><li class="post-copyright-author"><strong>æœ¬æ–‡ä½œè€…ï¼š</strong>ss</li><li class="post-copyright-link"><strong>æœ¬æ–‡é“¾æ¥ï¼š</strong><a href="/2019/08/03/å®éªŒå§-py137/">https://ssdemajia.github.io/2019/08/03/%E5%AE%9E%E9%AA%8C%E5%90%A7-py137/</a></li><li class="post-copyright-license"><strong>ç‰ˆæƒå£°æ˜ï¼š</strong>æœ¬ç«™æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ <a href="http://creativecommons.org/licenses/by-nc-sa/3.0/cn/" rel="external nofollow" target="_blank">CC BY-NC-SA 3.0 CN</a> è®¸å¯åè®®ã€‚è½¬è½½è¯·æ³¨æ˜å‡ºå¤„ï¼</li></ul></div><br><div class="tags"><a href="../../../../tags/ctf/">ctf</a></div><div class="post-nav"><a class="pre" href="../../10/%E8%87%AA%E5%88%B6%E8%AF%84%E8%AE%BA%E6%8F%92%E4%BB%B6/">è‡ªåˆ¶è¯„è®ºæ’ä»¶</a><a class="next" href="../../../07/26/shellcode%E7%BC%96%E5%86%99/">shellcodeç¼–å†™</a></div><div id="comments"><div id="disqus_thread"><div class="btn_click_load"><button class="disqus_click_btn">é˜…è¯»è¯„è®ºï¼ˆè¯·ç¡®ä¿ Disqus å¯ä»¥æ­£å¸¸åŠ è½½ï¼‰</button></div><script type="text/javascript">var disqus_config = function () {
    this.page.url = 'https://ssdemajia.github.io/2019/08/03/å®éªŒå§-py137/';
    this.page.identifier = '2019/08/03/å®éªŒå§-py137/';
    this.page.title = 'å®éªŒå§ py137';
  };</script><script type="text/javascript" id="disqus-lazy-load-script">$.ajax({
url: 'https://disqus.com/next/config.json',
timeout: 2500,
type: 'GET',
success: function(){
  var d = document;
  var s = d.createElement('script');
  s.src = '//dowob.disqus.com/embed.js';
  s.setAttribute('data-timestamp', + new Date());
  (d.head || d.body).appendChild(s);
  $('.disqus_click_btn').css('display', 'none');
},
error: function() {
  $('.disqus_click_btn').css('display', 'block');
}
});</script><script type="text/javascript" id="disqus-click-load">$('.btn_click_load').click(() => {  //click to load comments
    (() => { // DON'T EDIT BELOW THIS LINE
        var d = document;
        var s = d.createElement('script');
        s.src = '//dowob.disqus.com/embed.js';
        s.setAttribute('data-timestamp', + new Date());
        (d.head || d.body).appendChild(s);
    })();
    $('.disqus_click_btn').css('display','none');
});</script><script type="text/javascript" id="disqus-count-script">$(function() {
     var xhr = new XMLHttpRequest();
     xhr.open('GET', '//disqus.com/next/config.json', true);
     xhr.timeout = 2500;
     xhr.onreadystatechange = function () {
       if (xhr.readyState === 4 && xhr.status === 200) {
         $('.post-meta .post-comments-count').show();
         var s = document.createElement('script');
         s.id = 'dsq-count-scr';
         s.src = 'https://dowob.disqus.com/count.js';
         s.async = true;
         (document.head || document.body).appendChild(s);
       }
     };
     xhr.ontimeout = function () { xhr.abort(); };
     xhr.send(null);
   });  </script></div></div></div></div></div><div class="pure-u-1 pure-u-md-4"><div id="footer">Copyright Â© 2024 <a href="../../../../." rel="nofollow">SS.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/ssdemajia"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/ssdemajia"> SS.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="../../../../js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="../../../../js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="../../../../js/smartresize.js?v=0.0.0"></script></div></body></html>